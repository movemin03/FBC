<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBC Content Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            word-break: keep-all;
        }
        .font-serif, .font-serif * {
            font-family: 'Noto Serif KR', Georgia, serif !important;
        }

        .ProseMirror {
            padding: 20px;
            min-height: 400px;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
        }
        .ProseMirror p { margin: 0.75em 0; }
        .ProseMirror h1 { font-size: 2em; font-weight: bold; margin: 1em 0 0.5em; line-height: 1.2; }
        .ProseMirror h2 { font-size: 1.5em; font-weight: bold; margin: 0.8em 0 0.4em; line-height: 1.3; }
        .ProseMirror h3 { font-size: 1.25em; font-weight: bold; margin: 0.6em 0 0.3em; line-height: 1.4; }
        .ProseMirror strong { font-weight: bold; }
        .ProseMirror em { font-style: italic; }
        .ProseMirror u { text-decoration: underline; }
        .ProseMirror s { text-decoration: line-through; }
        .ProseMirror code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .ProseMirror mark {
            background: #fef08a;
            padding: 2px 0;
        }
        .ProseMirror img {
            max-width: 500px;
            height: auto;
            border-radius: 4px;
            margin: 1em 0;
            display: block;
        }
        .ProseMirror a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .ProseMirror .text-left { text-align: left; }
        .ProseMirror .text-center { text-align: center; }
        .ProseMirror .text-right { text-align: right; }
    </style>
</head>
<body class="bg-gray-50">

<!-- Upload Progress Modal -->
<div id="upload-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9998]"></div>
<div id="upload-progress" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-xl shadow-2xl z-[9999] min-w-[300px] text-center">
    <h3 class="text-lg font-bold mb-2">처리 중...</h3>
    <p id="upload-status" class="text-sm text-gray-600 mb-2">준비 중...</p>
    <div class="w-full h-2 bg-gray-200 rounded overflow-hidden mt-4">
        <div id="progress-fill" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
    </div>
    <p id="upload-detail" class="text-xs text-gray-500 mt-2"></p>
</div>

<!-- Header -->
<header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-3 items-center py-3 border-b">
            <div class="flex items-center space-x-4 text-xs">
                <button id="logout-btn" class="px-3 py-1 border border-gray-300 hover:bg-gray-100 transition">
                    로그아웃
                </button>
            </div>
            <div class="text-center">
                <a href="../index.html" class="hover:opacity-80 transition">
                    <h1 class="text-3xl font-serif font-bold tracking-wider">FBC</h1>
                </a>
            </div>
            <div class="flex items-center justify-end space-x-4 text-xs">
                <span class="text-gray-600">Admin Editor</span>
            </div>
        </div>
    </div>
</header>

<!-- Main Container -->
<div class="max-w-[1200px] mx-auto px-5 py-10">

    <!-- Mode Selection -->
    <div id="mode-selection" class="min-h-[80vh] flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-serif font-bold tracking-wider mb-2">FBC</h1>
                <p class="text-sm text-gray-600 tracking-widest uppercase">Content Editor</p>
            </div>
            <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-8">
                <h2 class="text-xl font-semibold text-center mb-6">작업 선택</h2>
                <p class="text-sm text-gray-600 text-center mb-8">어떤 작업을 하시겠습니까?</p>
                <div class="space-y-4">
                    <button id="btn-edit-mode" class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition">
                        기존 게시글 수정
                    </button>
                    <button id="btn-create-mode" class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition">
                        새로운 글 발행
                    </button>
                </div>
            </div>
            <div class="text-center mt-8">
                <a href="../index.html" class="text-sm text-gray-600 hover:text-black transition">
                    ← 메인으로 돌아가기
                </a>
            </div>
        </div>
    </div>

    <!-- Edit Mode: URL Input -->
    <div id="edit-url-input" class="hidden min-h-[80vh] flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-serif font-bold tracking-wider mb-2">FBC</h1>
                <p class="text-sm text-gray-600 tracking-widest uppercase">Edit Article</p>
            </div>
            <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-8">
                <h2 class="text-xl font-semibold mb-2">게시글 URL 입력</h2>
                <p class="text-sm text-gray-600 mb-6">수정할 게시글의 URL을 입력해주세요.</p>
                <div class="space-y-6">
                    <div>
                        <label for="article-url" class="block text-sm font-medium text-gray-700 mb-2">게시글 URL</label>
                        <input type="text" id="article-url" class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition text-sm" placeholder="http://localhost:8000/article/index.html?category=fashion&id=fs00001">
                    </div>
                    <button id="load-article-btn" class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition">
                        불러오기
                    </button>
                </div>
            </div>
            <div class="text-center mt-8">
                <button id="back-to-mode-select" class="text-sm text-gray-600 hover:text-black transition">
                    ← 작업 선택으로 돌아가기
                </button>
            </div>
        </div>
    </div>

    <!-- Editor Form -->
    <div id="editor-form" class="hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold" id="form-title">새 콘텐츠 발행</h1>
            <button id="cancel-edit-btn" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 transition">취소</button>
        </div>

        <input type="hidden" id="edit-article-id" value="">
        <input type="hidden" id="current-thumbnail-delete-url" value="">

        <!-- Category Selection -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">카테고리 선택 *</label>
            <select id="category" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" required>
                <option value="">-- 카테고리를 선택하세요 --</option>
                <option value="fashion">Fashion</option>
                <option value="beauty">Beauty</option>
                <option value="life">Life</option>
                <option value="districts">Districts</option>
            </select>
        </div>

        <!-- Title Inputs -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block font-semibold mb-2 text-sm">제목 (한국어) *</label>
                <input type="text" id="title-kor" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="한국어 제목" required>
            </div>
            <div class="flex gap-2">
                <input type="text" id="title-en" class="flex-1 px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="English title" required>
                <button id="translate-title-btn" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition text-sm whitespace-nowrap">영어 자동채우기</button>
            </div>
        </div>

        <!-- Description Inputs -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block font-semibold mb-2 text-sm">설명 (한국어) *</label>
                <input type="text" id="desc-kor" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="한국어 설명" required>
            </div>
            <div class="flex gap-2">
                <input type="text" id="desc-en" class="flex-1 px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="English description" required>
                <button id="translate-desc-btn" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition text-sm whitespace-nowrap">영어 자동채우기</button>
            </div>
        </div>

        <!-- Additional Fields -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2 text-sm">카테고리 세부 * (영어/숫자만)</label>
                    <input type="text" id="subcategory" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="예: Fashion Item" required>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">작성자 * (영어/숫자만)</label>
                    <input type="text" id="author" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="Author name" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block font-semibold mb-2 text-sm">썸네일 이미지 *</label>
                    <div class="flex gap-2">
                        <input type="file" id="thumbnail-file" accept="image/*" class="hidden">
                        <button id="thumbnail-upload-btn" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition text-sm">이미지 업로드</button>
                        <input type="text" id="thumbnail-url" class="flex-1 px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="또는 URL 입력" required>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">Cultural Badge (선택, 영어/숫자만)</label>
                    <input type="text" id="cultural-badge" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="예: Industrial Chic">
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">태그 (쉼표로 구분, 영어/숫자만)</label>
                    <input type="text" id="tags" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="tag1, tag2, tag3">
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">관련 지역 (선택)</label>
                    <select id="district-select" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm">
                        <option value="">-- 지역을 선택하세요 --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Content Editor (Korean) -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">본문 내용 (한국어) *</label>
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <div id="toolbar-kor" class="border-b border-gray-200 p-2 flex gap-1 flex-wrap bg-gray-50"></div>
                <div id="editor-kor"></div>
            </div>
        </div>

        <!-- Content Editor (English) -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">본문 내용 (English) *</label>
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <div id="toolbar-en" class="border-b border-gray-200 p-2 flex gap-1 flex-wrap bg-gray-50"></div>
                <div id="editor-en"></div>
            </div>
        </div>

        <!-- Publish Button -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 text-center">
            <button id="publish-btn" class="px-8 py-3 bg-black text-white rounded hover:bg-gray-800 transition font-semibold">
                <span id="publish-btn-text">발행하기</span>
            </button>
            <p class="text-sm text-gray-600 mt-4">
                <span id="publish-info-text">발행하면 Supabase에 데이터가 저장됩니다.</span>
            </p>
        </div>
    </div>

</div>
<script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core@2.1.13';
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.1.13';
    import TiptapImage from 'https://esm.sh/@tiptap/extension-image@2.1.13';
    import Link from 'https://esm.sh/@tiptap/extension-link@2.1.13';
    import Underline from 'https://esm.sh/@tiptap/extension-underline@2.1.13';
    import Highlight from 'https://esm.sh/@tiptap/extension-highlight@2.1.13';
    import TextAlign from 'https://esm.sh/@tiptap/extension-text-align@2.1.13';
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder@2.1.13';

    // Configuration
    const SUPABASE_URL = 'https://ipcibnhhegkhdwyxeqjs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwY2libmhoZWdraGR3eXhlcWpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MzMyNzYsImV4cCI6MjA3NjMwOTI3Nn0.LKjw1dqgjs39shvGpxcfFPutA7p1yR9eOb4zhomSBS8';
    const IMGBB_API_KEY = '4a0d69744fa47d8de59028ec369b7abc';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global State
    let editorKor = null;
    let editorEn = null;
    let isEditMode = false;
    const uploadedImages = new Set();

    const districtMeta = [
        { district_id: "dsm00001", name_kor: "성수동", name_en: "Seongsu-dong" },
        { district_id: "dsm00002", name_kor: "한남동", name_en: "Hannam-dong" },
        { district_id: "dsm00003", name_kor: "홍대", name_en: "Hongdae" },
        { district_id: "dsm00004", name_kor: "명동", name_en: "Myeongdong" }
    ];

    // 기존 icons 객체 그대로 사용
    const icons = [
        { name: 'Bold', icon: icons.bold, command: () => editor.chain().focus().toggleBold().run(), isActive: () => editor.isActive('bold') },
        { name: 'Italic', icon: icons.italic, command: () => editor.chain().focus().toggleItalic().run(), isActive: () => editor.isActive('italic') },
        { name: 'Underline', icon: icons.underline, command: () => editor.chain().focus().toggleUnderline().run(), isActive: () => editor.isActive('underline') },
        { name: 'Strike', icon: icons.strike, command: () => editor.chain().focus().toggleStrike().run(), isActive: () => editor.isActive('strike') },
        { name: 'Code', icon: icons.code, command: () => editor.chain().focus().toggleCode().run(), isActive: () => editor.isActive('code') },
        { name: 'Highlight', icon: icons.highlight, command: () => editor.chain().focus().toggleHighlight().run(), isActive: () => editor.isActive('highlight') },
        { name: 'Align Left', icon: icons.alignLeft, command: () => editor.chain().focus().setTextAlign('left').run(), isActive: () => editor.isActive({ textAlign: 'left' }) },
        { name: 'Align Center', icon: icons.alignCenter, command: () => editor.chain().focus().setTextAlign('center').run(), isActive: () => editor.isActive({ textAlign: 'center' }) },
        { name: 'Align Right', icon: icons.alignRight, command: () => editor.chain().focus().setTextAlign('right').run(), isActive: () => editor.isActive({ textAlign: 'right' }) },
    ];

    // ============================================
    // Utility Functions
    // ============================================
    function showProgress(show = true) {
        document.getElementById('upload-overlay').classList.toggle('hidden', !show);
        document.getElementById('upload-progress').classList.toggle('hidden', !show);
    }

    function updateProgress(percent, status, detail = '') {
        document.getElementById('progress-fill').style.width = `${percent}%`;
        document.getElementById('upload-status').textContent = status;
        document.getElementById('upload-detail').textContent = detail;
    }

    function showSection(showId) {
        ['mode-selection', 'edit-url-input', 'editor-form'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(showId).classList.remove('hidden');
    }

    function extractUrlParams(url) {
        try {
            const urlObj = new URL(url);
            const params = new URLSearchParams(urlObj.search);
            return { category: params.get('category'), id: params.get('id') };
        } catch (error) {
            return { category: null, id: null };
        }
    }

    async function generateNextId(category) {
        const prefix = { 'fashion': 'fs', 'beauty': 'by', 'life': 'lf', 'districts': 'ds' }[category];
        try {
            const { data, error } = await supabaseClient
                .from('content_items')
                .select('id')
                .eq('source_type', category)
                .order('id', { ascending: false })
                .limit(1);

            if (error) throw error;

            if (data && data.length > 0) {
                const lastId = data[0].id;
                const match = lastId.match(/\d+$/);
                const num = match ? parseInt(match[0]) + 1 : 1;
                return `${prefix}${String(num).padStart(5, '0')}`;
            }
            return `${prefix}00001`;
        } catch (error) {
            console.error('ID generation error:', error);
            return `${prefix}00001`;
        }
    }

    // ============================================
    // Image Processing Functions
    // ============================================

    /**
     * Convert image to sRGB WebP format
     */
    async function convertToWebP(file, maxWidth = 1200, quality = 0.85) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d', {
                        colorSpace: 'srgb',
                        willReadFrequently: false
                    });

                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('WebP 변환 실패'));
                        }
                    }, 'image/webp', quality);
                };
                img.onerror = () => reject(new Error('이미지 로드 실패'));
                img.src = e.target.result;
            };
            reader.onerror = () => reject(new Error('파일 읽기 실패'));
            reader.readAsDataURL(file);
        });
    }

    /**
     * Upload image to ImgBB with WebP conversion
     * Returns both display URL and origin URL
     */
    async function uploadToImgBB(file) {
        try {
            updateProgress(30, '이미지를 WebP로 변환 중...', 'sRGB 색공간 적용');
            const webpBlob = await convertToWebP(file);

            const formData = new FormData();
            const webpFile = new File([webpBlob],
                file.name.replace(/\.\w+$/, '.webp'),
                { type: 'image/webp' }
            );
            formData.append('image', webpFile);

            updateProgress(60, 'ImgBB에 업로드 중...', `파일 크기: ${(webpBlob.size / 1024).toFixed(1)} KB`);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // ImgBB는 여러 URL을 제공 - display_url과 url(원본) 모두 저장
                return {
                    url: data.data.display_url,           // 표시용 URL (썸네일/중간크기)
                    originUrl: data.data.url,             // 원본 이미지 URL
                    deleteUrl: data.data.delete_url
                };
            } else {
                throw new Error('ImgBB 업로드 실패');
            }
        } catch (error) {
            console.error('Upload error:', error);
            throw error;
        }
    }

    async function deleteFromImgBB(deleteUrl) {
        if (!deleteUrl) return;
        try {
            await fetch(deleteUrl, { method: 'GET' });
        } catch (error) {
            console.error('ImgBB delete error:', error);
        }
    }

    // ============================================
    // Translation Function
    // ============================================
    async function translateText(text, from = 'ko', to = 'en') {
        if (!text.trim()) return '';
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            return data.responseData.translatedText;
        } catch (error) {
            console.error('Translation error:', error);
            return text;
        }
    }

    // ============================================
    // Editor Initialization
    // ============================================
    function createToolbar(editor, toolbarId) {
        const toolbar = document.getElementById(toolbarId);

        const buttons = [
            { name: 'Bold', icon: icons.bold, command: () => editor.chain().focus().toggleBold().run(), isActive: () => editor.isActive('bold') },
            { name: 'Italic', icon: icons.italic, command: () => editor.chain().focus().toggleItalic().run(), isActive: () => editor.isActive('italic') },
            { name: 'Underline', icon: icons.underline, command: () => editor.chain().focus().toggleUnderline().run(), isActive: () => editor.isActive('underline') },
            { name: 'Strike', icon: icons.strike, command: () => editor.chain().focus().toggleStrike().run(), isActive: () => editor.isActive('strike') },
            { name: 'Code', icon: icons.code, command: () => editor.chain().focus().toggleCode().run(), isActive: () => editor.isActive('code') },
            { name: 'Highlight', icon: icons.highlight, command: () => editor.chain().focus().toggleHighlight().run(), isActive: () => editor.isActive('highlight') },
            { name: 'Align Left', icon: icons.alignLeft, command: () => editor.chain().focus().setTextAlign('left').run(), isActive: () => editor.isActive({ textAlign: 'left' }) },
            { name: 'Align Center', icon: icons.alignCenter, command: () => editor.chain().focus().setTextAlign('center').run(), isActive: () => editor.isActive({ textAlign: 'center' }) },
            { name: 'Align Right', icon: icons.alignRight, command: () => editor.chain().focus().setTextAlign('right').run(), isActive: () => editor.isActive({ textAlign: 'right' }) },
        ];

        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'p-2 rounded hover:bg-gray-200 transition';
            button.innerHTML = btn.icon;
            button.title = btn.name;
            button.type = 'button';
            button.onclick = btn.command;

            if (btn.isActive) {
                const updateState = () => {
                    button.classList.toggle('bg-gray-300', btn.isActive());
                };
                editor.on('selectionUpdate', updateState);
                editor.on('update', updateState);
                updateState();
            }

            toolbar.appendChild(button);
        });

        // Link button
        const linkBtn = document.createElement('button');
        linkBtn.className = 'p-2 rounded hover:bg-gray-200 transition';
        linkBtn.innerHTML = icons.link;
        linkBtn.title = 'Add Link';
        linkBtn.type = 'button';
        linkBtn.onclick = () => {
            const url = window.prompt('URL:');
            if (url) {
                editor.chain().focus().setLink({ href: url }).run();
            }
        };
        toolbar.appendChild(linkBtn);

        // Image button with WebP conversion
        const imageBtn = document.createElement('button');
        imageBtn.className = 'p-2 rounded hover:bg-gray-200 transition';
        imageBtn.innerHTML = icons.image;
        imageBtn.title = 'Add Image (WebP)';
        imageBtn.type = 'button';
        imageBtn.onclick = async () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        showProgress(true);
                        updateProgress(10, '이미지 처리 시작...', file.name);

                        const { url, originUrl, deleteUrl } = await uploadToImgBB(file);

                        // 에디터에는 표시용 URL 삽입
                        editor.chain().focus().setImage({ src: url }).run();
                        uploadedImages.add(url);

                        updateProgress(100, '업로드 완료!', 'sRGB WebP로 변환됨');
                        setTimeout(() => showProgress(false), 500);
                    } catch (error) {
                        showProgress(false);
                        alert(`업로드 실패: ${error.message}`);
                    }
                }
            };
            input.click();
        };
        toolbar.appendChild(imageBtn);
    }

    function initializeEditors() {
        const extensions = [
            StarterKit,
            TiptapImage.configure({ inline: false }),
            Link.configure({ openOnClick: false }),
            Underline,
            Highlight.configure({ multicolor: false }),
            TextAlign.configure({ types: ['heading', 'paragraph'] })
        ];

        editorKor = new Editor({
            element: document.querySelector('#editor-kor'),
            extensions: [
                ...extensions,
                Placeholder.configure({ placeholder: '한국어 콘텐츠를 입력하세요...' })
            ],
            content: '',
            onUpdate: ({ editor }) => {
                const currentHtml = editor.getHTML();
                const currentImages = new Set();
                const imgRegex = /<img[^>]+src="([^">]+)"/g;
                let match;
                while ((match = imgRegex.exec(currentHtml)) !== null) {
                    currentImages.add(match[1]);
                }

                uploadedImages.forEach(imgUrl => {
                    if (!currentImages.has(imgUrl)) {
                        uploadedImages.delete(imgUrl);
                    }
                });
            }
        });

        editorEn = new Editor({
            element: document.querySelector('#editor-en'),
            extensions: [
                ...extensions,
                Placeholder.configure({ placeholder: 'Enter English content...' })
            ],
            content: ''
        });

        createToolbar(editorKor, 'toolbar-kor');
        createToolbar(editorEn, 'toolbar-en');
    }

    // ============================================
    // Auth Check
    // ============================================
    async function checkAuth() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session?.user) {
                alert('로그인이 필요합니다.');
                window.location.href = 'admin.html';
            }
        } catch (error) {
            console.error('Auth check error:', error);
            window.location.href = 'admin.html';
        }
    }

    // ============================================
    // Load Article
    // ============================================
    async function loadArticle(category, articleId) {
        try {
            showProgress(true);
            updateProgress(20, '기사 정보 로드 중...');

            const { data: contentData, error: contentError } = await supabaseClient
                .from('content_items')
                .select('*')
                .eq('id', articleId)
                .single();

            if (contentError) throw contentError;

            updateProgress(50, 'HTML 콘텐츠 로드 중...');

            const { data: articleData, error: articleError } = await supabaseClient
                .from('articles')
                .select('*')
                .eq('id', articleId)
                .single();

            if (articleError) throw articleError;

            updateProgress(80, '폼 데이터 설정 중...');

            document.getElementById('edit-article-id').value = articleId;
            document.getElementById('category').value = contentData.source_type;
            document.getElementById('title-kor').value = contentData.title_kor;
            document.getElementById('title-en').value = contentData.title_en;
            document.getElementById('desc-kor').value = contentData.desc_kor;
            document.getElementById('desc-en').value = contentData.desc_en;
            document.getElementById('subcategory').value = contentData.category;
            document.getElementById('author').value = contentData.author;
            document.getElementById('thumbnail-url').value = contentData.image;
            document.getElementById('cultural-badge').value = contentData.cultural_badge || '';
            document.getElementById('tags').value = (contentData.tags || []).join(', ');
            document.getElementById('district-select').value = contentData.district_id || '';

            // 원본 URL도 저장 (있다면)
            if (contentData.image_origin_url) {
                document.getElementById('current-thumbnail-origin-url').value = contentData.image_origin_url;
            }

            editorKor.commands.setContent(articleData.article_html_ko);
            editorEn.commands.setContent(articleData.article_html_en);

            document.getElementById('form-title').textContent = '기사 수정';
            document.getElementById('publish-btn-text').textContent = '업데이트';
            document.getElementById('publish-info-text').textContent = 'Supabase 데이터베이스에 변경사항을 저장합니다.';

            isEditMode = true;

            updateProgress(100, '완료!');
            setTimeout(() => {
                showProgress(false);
                showSection('editor-form');
            }, 500);

        } catch (error) {
            console.error('Load article error:', error);
            showProgress(false);
            alert(`기사 로드 실패: ${error.message}`);
        }
    }

    // ============================================
    // Publish Article
    // ============================================
    async function publishArticle() {
        const category = document.getElementById('category').value;
        const titleKor = document.getElementById('title-kor').value;
        const titleEn = document.getElementById('title-en').value;
        const descKor = document.getElementById('desc-kor').value;
        const descEn = document.getElementById('desc-en').value;
        const subcategory = document.getElementById('subcategory').value;
        const author = document.getElementById('author').value;
        const thumbnailUrl = document.getElementById('thumbnail-url').value;
        const thumbnailOriginUrl = document.getElementById('current-thumbnail-origin-url').value;
        const culturalBadge = document.getElementById('cultural-badge').value || null;
        const tagsInput = document.getElementById('tags').value;
        const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(Boolean) : [];
        const districtId = document.getElementById('district-select').value || null;

        if (!category) return alert('카테고리를 선택하세요.');
        if (!titleKor || !titleEn) return alert('제목을 입력하세요.');
        if (!descKor || !descEn) return alert('설명을 입력하세요.');
        if (!subcategory) return alert('서브카테고리를 입력하세요.');
        if (!author) return alert('작성자를 입력하세요.');
        if (!thumbnailUrl) return alert('썸네일 URL을 입력하세요.');

        const contentKor = editorKor.getHTML();
        const contentEn = editorEn.getHTML();

        if (!contentKor || contentKor === '<p></p>') return alert('한국어 콘텐츠를 입력하세요.');
        if (!contentEn || contentEn === '<p></p>') return alert('English 콘텐츠를 입력하세요.');

        const editArticleId = document.getElementById('edit-article-id').value;
        const articleId = editArticleId || await generateNextId(category);
        const today = new Date().toISOString().split('T')[0];

        try {
            showProgress(true);
            updateProgress(20, isEditMode ? '기사 업데이트 중...' : '새 기사 생성 중...');

            const contentData = {
                id: articleId,
                source_type: category,
                district_id: districtId,
                title_kor: titleKor,
                title_en: titleEn,
                desc_kor: descKor,
                desc_en: descEn,
                category: subcategory,
                image: thumbnailUrl,                      // 표시용 URL
                image_origin_url: thumbnailOriginUrl,     // 원본 URL
                tags: tags,
                cultural_badge: culturalBadge,
                date: today,
                author: author,
                views: 0
            };

            const articleData = {
                id: articleId,
                article_html_ko: contentKor,
                article_html_en: contentEn
            };

            updateProgress(50, 'content_items 저장 중...');
            const { error: contentError } = await supabaseClient
                .from('content_items')
                .upsert(contentData, { onConflict: 'id' });

            if (contentError) throw contentError;

            updateProgress(75, 'articles 저장 중...');
            const { error: articleError } = await supabaseClient
                .from('articles')
                .upsert(articleData, { onConflict: 'id' });

            if (articleError) throw articleError;

            updateProgress(100, '완료!');
            setTimeout(() => {
                showProgress(false);
                alert(isEditMode ? '기사가 업데이트되었습니다!' : '새 기사가 발행되었습니다!');
                location.reload();
            }, 1000);

        } catch (error) {
            console.error('Publish error:', error);
            showProgress(false);
            alert(`발행 실패: ${error.message}`);
        }
    }

    // ============================================
    // Event Listeners
    // ============================================
    document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = 'admin.html';
    });

    document.getElementById('btn-edit-mode').addEventListener('click', () => {
        showSection('edit-url-input');
    });

    document.getElementById('btn-create-mode').addEventListener('click', () => {
        isEditMode = false;
        document.getElementById('form-title').textContent = '새 기사 작성';
        document.getElementById('publish-btn-text').textContent = '발행';
        document.getElementById('publish-info-text').textContent = 'Supabase 데이터베이스에 새 기사를 저장합니다.';
        showSection('editor-form');
    });

    document.getElementById('back-to-mode-select').addEventListener('click', () => {
        showSection('mode-selection');
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', () => {
        if (confirm('작성 중인 내용이 사라집니다. 취소하시겠습니까?')) {
            location.reload();
        }
    });

    document.getElementById('load-article-btn').addEventListener('click', () => {
        const url = document.getElementById('article-url').value.trim();
        if (!url) {
            alert('URL을 입력하세요.');
            return;
        }

        const { category, id } = extractUrlParams(url);
        if (!category || !id) {
            alert('유효하지 않은 URL 형식입니다.');
            return;
        }

        loadArticle(category, id);
    });

    // Thumbnail upload with WebP conversion and dual URL storage
    document.getElementById('thumbnail-upload-btn').addEventListener('click', () => {
        document.getElementById('thumbnail-file').click();
    });

    document.getElementById('thumbnail-file').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                showProgress(true);

                // Delete old thumbnail if exists
                const oldDeleteUrl = document.getElementById('current-thumbnail-delete-url').value;
                if (oldDeleteUrl) {
                    updateProgress(30, '기존 썸네일 삭제 중...');
                    await deleteFromImgBB(oldDeleteUrl);
                }

                updateProgress(40, '새 썸네일 업로드 중...', 'sRGB WebP로 변환');
                const { url, originUrl, deleteUrl } = await uploadToImgBB(file);

                // 표시용 URL과 원본 URL 모두 저장
                document.getElementById('thumbnail-url').value = url;
                document.getElementById('current-thumbnail-origin-url').value = originUrl;
                document.getElementById('current-thumbnail-delete-url').value = deleteUrl;

                updateProgress(100, '썸네일 업로드 완료!');
                setTimeout(() => showProgress(false), 500);

            } catch (error) {
                showProgress(false);
                alert(`썸네일 업로드 실패: ${error.message}`);
            }
        }
    });

    // Translation buttons
    document.getElementById('translate-title-btn').addEventListener('click', async () => {
        const korText = document.getElementById('title-kor').value;
        if (!korText) return alert('한국어 제목을 입력하세요.');

        showProgress(true);
        updateProgress(50, '번역 중...');

        const translated = await translateText(korText);
        document.getElementById('title-en').value = translated;

        updateProgress(100, '번역 완료!');
        setTimeout(() => showProgress(false), 500);
    });

    document.getElementById('translate-desc-btn').addEventListener('click', async () => {
        const korText = document.getElementById('desc-kor').value;
        if (!korText) return alert('한국어 설명을 입력하세요.');

        showProgress(true);
        updateProgress(50, '번역 중...');

        const translated = await translateText(korText);
        document.getElementById('desc-en').value = translated;

        updateProgress(100, '번역 완료!');
        setTimeout(() => showProgress(false), 500);
    });

    document.getElementById('publish-btn').addEventListener('click', publishArticle);

    // Input validation
    ['subcategory', 'author', 'cultural-badge', 'tags'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                this.value = this.value.replace(/[^A-Za-z0-9ㄱ-힣\s,-]/g, '');
            });
        }
    });

    // Initialize district options
    districtMeta.forEach(district => {
        const option = document.createElement('option');
        option.value = district.district_id;
        option.textContent = district.name_kor;
        document.getElementById('district-select').appendChild(option);
    });

    // Hidden input for storing origin URL
    if (!document.getElementById('current-thumbnail-origin-url')) {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = 'current-thumbnail-origin-url';
        document.body.appendChild(hiddenInput);
    }

    // Initialize
    initializeEditors();
    checkAuth();
</script>

</body>
</html>
