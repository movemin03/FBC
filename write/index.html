<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBC Content Editor</title>
    <script src="../config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Font Awesome Kit -->
    <script src="https://kit.fontawesome.com/d0f28f3633.js" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            word-break: keep-all;
        }
        .font-serif, .font-serif * {
            font-family: 'Noto Serif KR', Georgia, serif !important;
        }

        .ProseMirror {
            padding: 20px;
            min-height: 400px;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
        }
        .ProseMirror p { margin: 0.75em 0; }
        .ProseMirror h1 { font-size: 2em; font-weight: bold; margin: 1em 0 0.5em; line-height: 1.2; }
        .ProseMirror h2 { font-size: 1.5em; font-weight: bold; margin: 0.8em 0 0.4em; line-height: 1.3; }
        .ProseMirror h3 { font-size: 1.25em; font-weight: bold; margin: 0.6em 0 0.3em; line-height: 1.4; }
        .ProseMirror strong { font-weight: bold; }
        .ProseMirror em { font-style: italic; }
        .ProseMirror u { text-decoration: underline; }
        .ProseMirror s { text-decoration: line-through; }
        .ProseMirror code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace !important;
            font-size: 0.9em;
        }
        .ProseMirror mark {
            padding: 2px 0;
        }
        .ProseMirror blockquote {
            border-left: 4px solid #333;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #555;
        }
        .ProseMirror ul,
        .ProseMirror ol {
            padding-left: 2em;
            margin: 1em 0;
        }
        .ProseMirror li {
            margin: 0.25em 0;
        }
        .ProseMirror img {
            max-width: 500px;
            height: auto;
            border-radius: 4px;
            margin: 1em 0;
            display: block;
        }
        .ProseMirror a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .ProseMirror .text-left { text-align: left; }
        .ProseMirror .text-center { text-align: center; }
        .ProseMirror .text-right { text-align: right; }

        /* Color picker wrapper */
        .color-picker-wrapper {
            position: relative;
            display: inline-block;
        }

        .color-picker-wrapper input[type="color"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Color palette popup */
        .color-palette {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            width: 160px;
        }

        .color-palette.active {
            display: grid;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            border-color: #333;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- Upload Progress Modal -->
<div id="upload-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9998]"></div>
<div id="upload-progress" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-xl shadow-2xl z-[9999] min-w-[300px] text-center">
    <h3 class="text-lg font-bold mb-2">처리 중...</h3>
    <p id="upload-status" class="text-sm text-gray-600 mb-2">준비 중...</p>
    <div class="w-full h-2 bg-gray-200 rounded overflow-hidden mt-4">
        <div id="progress-fill" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
    </div>
    <p id="upload-detail" class="text-xs text-gray-500 mt-2"></p>
</div>

<!-- Header -->
<header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-3 items-center py-3 border-b">
            <div class="flex items-center space-x-4 text-xs">
                <button id="logout-btn" class="px-3 py-1 border border-gray-300 hover:bg-gray-100 transition">
                    로그아웃
                </button>
            </div>
            <div class="text-center">
                <a href="../index.html" class="hover:opacity-80 transition">
                    <h1 class="text-3xl font-serif font-bold tracking-wider">FBC</h1>
                </a>
            </div>
            <div class="flex items-center justify-end space-x-4 text-xs">
                <span class="text-gray-600">Admin Editor</span>
            </div>
        </div>
    </div>
</header>

<!-- Main Container -->
<div class="max-w-[1200px] mx-auto px-5 py-10">

    <!-- Mode Selection -->
    <div id="mode-selection" class="min-h-[80vh] flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-serif font-bold tracking-wider mb-2">FBC</h1>
                <p class="text-sm text-gray-600 tracking-widest uppercase">Content Editor</p>
            </div>
            <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-8">
                <h2 class="text-xl font-semibold text-center mb-6">작업 선택</h2>
                <p class="text-sm text-gray-600 text-center mb-8">어떤 작업을 하시겠습니까?</p>
                <div class="space-y-4">
                    <button id="btn-edit-mode" class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition">
                        기존 게시글 수정
                    </button>
                    <button id="btn-create-mode" class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition">
                        새로운 글 발행
                    </button>
                </div>
            </div>
            <div class="text-center mt-8">
                <a href="../index.html" class="text-sm text-gray-600 hover:text-black transition">
                    ← 메인으로 돌아가기
                </a>
            </div>
        </div>
    </div>

    <!-- Edit Mode: URL Input -->
    <div id="edit-url-input" class="hidden min-h-[80vh] flex items-center justify-center px-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-5xl font-serif font-bold tracking-wider mb-2">FBC</h1>
                <p class="text-sm text-gray-600 tracking-widest uppercase">Edit Article</p>
            </div>
            <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-8">
                <h2 class="text-xl font-semibold mb-2">게시글 URL 입력</h2>
                <p class="text-sm text-gray-600 mb-6">수정할 게시글의 URL을 입력해주세요.</p>
                <div class="space-y-6">
                    <div>
                        <label for="article-url" class="block text-sm font-medium text-gray-700 mb-2">게시글 URL</label>
                        <input type="text" id="article-url" class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition text-sm" placeholder="http://localhost:8000/article/index.html?category=fashion&id=fs00001">
                    </div>
                    <button id="load-article-btn" class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition">
                        불러오기
                    </button>
                </div>
            </div>
            <div class="text-center mt-8">
                <button id="back-to-mode-select" class="text-sm text-gray-600 hover:text-black transition">
                    ← 작업 선택으로 돌아가기
                </button>
            </div>
        </div>
    </div>

    <!-- Editor Form -->
    <div id="editor-form" class="hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold" id="form-title">새 콘텐츠 발행</h1>
            <button id="cancel-edit-btn" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 transition">취소</button>
        </div>

        <input type="hidden" id="edit-article-id" value="">
        <input type="hidden" id="current-thumbnail-delete-url" value="">

        <!-- Category Selection -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">카테고리 선택 *</label>
            <select id="category" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" required>
                <option value="">-- 카테고리를 선택하세요 --</option>
                <option value="fashion">Fashion</option>
                <option value="beauty">Beauty</option>
                <option value="life">Life</option>
                <option value="districts">Districts</option>
            </select>
        </div>

        <!-- Title Inputs -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block font-semibold mb-2 text-sm">제목 (한국어) *</label>
                <input type="text" id="title-kor" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="한국어 제목" required>
            </div>
            <div class="flex gap-2">
                <input type="text" id="title-en" class="flex-1 px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="English title" required>
                <button id="translate-title-btn" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition text-sm whitespace-nowrap">영어 자동채우기</button>
            </div>
        </div>

        <!-- Description Inputs -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block font-semibold mb-2 text-sm">설명 (한국어) *</label>
                <input type="text" id="desc-kor" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="한국어 설명" required>
            </div>
            <div class="flex gap-2">
                <input type="text" id="desc-en" class="flex-1 px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="English description" required>
                <button id="translate-desc-btn" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition text-sm whitespace-nowrap">영어 자동채우기</button>
            </div>
        </div>

        <!-- Additional Fields -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2 text-sm">카테고리 세부 * (영어/숫자만)</label>
                    <input type="text" id="subcategory" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="예: Fashion Item" required>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">작성자 * (영어/숫자만)</label>
                    <input type="text" id="author" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="Author name" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block font-semibold mb-2 text-sm">썸네일 이미지 *</label>
                    <div class="flex gap-2">
                        <input type="file" id="thumbnail-file" accept="image/*" class="hidden">
                        <button id="thumbnail-upload-btn" class="px-4 py-2 bg-black text-white rounded hover:bg-gray-800 transition text-sm">이미지 업로드</button>
                        <input type="text" id="thumbnail-url" class="flex-1 px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="또는 URL 입력" required>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">Cultural Badge (선택, 영어/숫자만)</label>
                    <input type="text" id="cultural-badge" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="예: Industrial Chic">
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">태그 (쉼표로 구분, 영어/숫자만)</label>
                    <input type="text" id="tags" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="tag1, tag2, tag3">
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">관련 지역 (선택)</label>
                    <select id="district-select" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm">
                        <option value="">-- 지역을 선택하세요 --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Content Editor (Korean) -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">본문 내용 (한국어) *</label>
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <div id="toolbar-kor" class="border-b border-gray-200 p-2 flex gap-1 flex-wrap bg-gray-50"></div>
                <div id="editor-kor"></div>
            </div>
        </div>

        <!-- Content Editor (English) -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">본문 내용 (English) *</label>
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <div id="toolbar-en" class="border-b border-gray-200 p-2 flex gap-1 flex-wrap bg-gray-50"></div>
                <div id="editor-en"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white border border-gray-200 rounded-lg p-6">
            <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
                <button id="delete-article-btn" class="w-full sm:w-auto px-8 py-3 bg-red-600 text-white rounded hover:bg-red-700 transition font-semibold">
                    게시글 삭제
                </button>
                <button id="reset-form-btn" class="w-full sm:w-auto px-8 py-3 bg-gray-600 text-white rounded hover:bg-gray-700 transition font-semibold">
                    폼 초기화
                </button>
                <button id="publish-btn" class="w-full sm:w-auto px-8 py-3 bg-black text-white rounded hover:bg-gray-800 transition font-semibold">
                    <span id="publish-btn-text">발행하기</span>
                </button>
            </div>
        </div>
    </div>

</div>
<script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core@2.1.13';
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.1.13';
    import TiptapImage from 'https://esm.sh/@tiptap/extension-image@2.1.13';
    import Link from 'https://esm.sh/@tiptap/extension-link@2.1.13';
    import Underline from 'https://esm.sh/@tiptap/extension-underline@2.1.13';
    import Highlight from 'https://esm.sh/@tiptap/extension-highlight@2.1.13';
    import TextAlign from 'https://esm.sh/@tiptap/extension-text-align@2.1.13';
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder@2.1.13';
    import TextStyle from 'https://esm.sh/@tiptap/extension-text-style@2.1.13';
    import Color from 'https://esm.sh/@tiptap/extension-color@2.1.13';

    // ============================================
    // Supabase Configuration
    // ============================================
    const BUCKET_NAME = window.ENV.SUPABASE_BUCKET_NAME;
    const SUPABASE_URL = window.ENV.SUPABASE_URL;
    const SUPABASE_SERVICE_KEY = window.ENV.SUPABASE_SERVICE_KEY;

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    // ============================================
    // Global Variables
    // ============================================
    let editorKor = null;
    let editorEn = null;
    let isEditMode = false;
    let currentArticleId = null;
    let uploadedThumbnailUrl = null;
    let currentThumbnailFileName = null;

    const districtMeta = [
        { district_id: "dsm00001", name_kor: "성수동", name_en: "Seongsu-dong" },
        { district_id: "dsm00002", name_kor: "한남동", name_en: "Hannam-dong" },
        { district_id: "dsm00003", name_kor: "홍대", name_en: "Hongdae" },
        { district_id: "dsm00004", name_kor: "명동", name_en: "Myeongdong" }
    ];

    // Color palettes
    const textColors = [
        '#000000', '#333333', '#666666', '#999999', '#CCCCCC',
        '#FF0000', '#FF6B6B', '#FFA500', '#FFD700', '#FFFF00',
        '#00FF00', '#4CAF50', '#00CED1', '#1E90FF', '#0000FF',
        '#800080', '#FF1493', '#FF69B4', '#8B4513', '#FFFFFF'
    ];

    const highlightColors = [
        '#FFFF00', '#FFE4B5', '#FFB6C1', '#E6E6FA', '#B0E0E6',
        '#98FB98', '#FFA07A', '#DDA0DD', '#F0E68C', '#FFE4E1',
        '#E0FFFF', '#FAFAD2', '#D3D3D3', '#F5DEB3', '#FFC0CB'
    ];

    // ============================================
    // Image Processing Functions
    // ============================================
    async function resizeImage(file, maxWidth = 720) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d', { colorSpace: 'srgb' });
                    ctx.drawImage(img, 0, 0, width, height);

                    const base64 = canvas.toDataURL('image/webp', 0.85);
                    resolve(base64);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function convertToSRGBWebP(file, maxSizeKB = 40) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;

                    const ctx = canvas.getContext('2d', { colorSpace: 'srgb' });
                    ctx.drawImage(img, 0, 0);

                    let quality = 0.9;
                    let blob = null;

                    while (quality > 0.1) {
                        blob = await new Promise(res =>
                            canvas.toBlob(res, 'image/webp', quality)
                        );

                        if (blob.size / 1024 <= maxSizeKB || quality <= 0.1) {
                            break;
                        }
                        quality -= 0.05;
                    }

                    resolve(blob);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function uploadImageToSupabase(blob, fileName) {
        try {
            const storagePath = `contents/${fileName}`;

            const { data, error } = await supabaseClient.storage
                .from(BUCKET_NAME)
                .upload(storagePath, blob, {
                    contentType: 'image/webp',
                    upsert: true
                });

            if (error) throw error;

            const { data: urlData } = supabaseClient.storage
                .from(BUCKET_NAME)
                .getPublicUrl(storagePath);

            return urlData.publicUrl;
        } catch (error) {
            console.error('Upload error:', error);
            throw error;
        }
    }

    function base64ToBlob(base64) {
        const parts = base64.split(';base64,');
        const contentType = parts[0].split(':')[1];
        const raw = window.atob(parts[1]);
        const rawLength = raw.length;
        const uInt8Array = new Uint8Array(rawLength);

        for (let i = 0; i < rawLength; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }

        return new Blob([uInt8Array], { type: contentType });
    }

    async function deleteImageFromSupabase(fileName) {
        try {
            const storagePath = `contents/${fileName}`;

            const { error } = await supabaseClient.storage
                .from(BUCKET_NAME)
                .remove([storagePath]);

            if (error) throw error;
            return true;
        } catch (error) {
            console.warn('Image deletion failed:', error);
            return false;
        }
    }

    // ============================================
    // Article ID Generator
    // ============================================
    async function generateArticleId(category) {
        const prefix = {
            'fashion': 'fs',
            'beauty': 'bt',
            'life': 'lf',
            'districts': 'ds'
        }[category] || 'xx';

        try {
            const { data, error } = await supabaseClient
                .from('content_items')
                .select('id')
                .eq('source_type', category)
                .order('id', { ascending: false });

            if (error) throw error;

            let maxNumber = 0;

            if (data && data.length > 0) {
                data.forEach(item => {
                    const match = item.id.match(/^[a-z]{2}(\d{5})$/);
                    if (match) {
                        const num = parseInt(match[1], 10);
                        if (num > maxNumber) {
                            maxNumber = num;
                        }
                    }
                });
            }

            const nextNumber = (maxNumber + 1).toString().padStart(5, '0');

            if (nextNumber > 99999) {
                throw new Error(`${category} 카테고리의 ID가 한계에 도달했습니다.`);
            }

            return `${prefix}${nextNumber}`;

        } catch (error) {
            console.error('ID 생성 오류:', error);
            const randomNum = Math.floor(Math.random() * 100000).toString().padStart(5, '0');
            return `${prefix}${randomNum}`;
        }
    }

    // ============================================
    // Thumbnail Upload Handler
    // ============================================
    document.getElementById('thumbnail-upload-btn').addEventListener('click', () => {
        document.getElementById('thumbnail-file').click();
    });

    document.getElementById('thumbnail-file').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        let articleId = document.getElementById('edit-article-id').value;
        if (!articleId) {
            const category = document.getElementById('category').value;
            if (!category) {
                alert('먼저 카테고리를 선택해주세요.');
                e.target.value = '';
                return;
            }
            articleId = await generateArticleId(category);
            document.getElementById('edit-article-id').value = articleId;
        }

        showProgress('이미지 처리 중...', 0);

        try {
            updateProgress('이미지 압축 중...', 30);
            const webpBlob = await convertToSRGBWebP(file, 40);

            const fileName = `${articleId}.webp`;
            updateProgress('이미지 업로드 중...', 60);
            uploadedThumbnailUrl = await uploadImageToSupabase(webpBlob, fileName);
            currentThumbnailFileName = fileName;

            document.getElementById('thumbnail-url').value = uploadedThumbnailUrl;
            updateProgress('완료!', 100);

            setTimeout(hideProgress, 500);
            alert(`이미지 업로드 완료! (${(webpBlob.size / 1024).toFixed(2)} KB)`);

        } catch (error) {
            hideProgress();
            alert('이미지 업로드 실패: ' + error.message);
        }

        e.target.value = '';
    });

    // ============================================
    // Color Palette Helper
    // ============================================
    function createColorPalette(colors, onSelect) {
        const palette = document.createElement('div');
        palette.className = 'color-palette';

        colors.forEach(color => {
            const option = document.createElement('div');
            option.className = 'color-option';
            option.style.backgroundColor = color;
            option.title = color;
            option.onclick = (e) => {
                e.stopPropagation();
                onSelect(color);
                palette.classList.remove('active');
            };
            palette.appendChild(option);
        });

        return palette;
    }

    // ============================================
    // Editor Toolbar
    // ============================================
    function createToolbar(editor, toolbarId) {
        const toolbar = document.getElementById(toolbarId);
        const buttons = [
            { name: 'Bold', icon: 'fa-solid fa-bold', command: () => editor.chain().focus().toggleBold().run(), isActive: () => editor.isActive('bold') },
            { name: 'Italic', icon: 'fa-solid fa-italic', command: () => editor.chain().focus().toggleItalic().run(), isActive: () => editor.isActive('italic') },
            { name: 'Underline', icon: 'fa-solid fa-underline', command: () => editor.chain().focus().toggleUnderline().run(), isActive: () => editor.isActive('underline') },
            { name: 'Strike', icon: 'fa-solid fa-strikethrough', command: () => editor.chain().focus().toggleStrike().run(), isActive: () => editor.isActive('strike') },
            { name: 'Code', icon: 'fa-solid fa-code', command: () => editor.chain().focus().toggleCode().run(), isActive: () => editor.isActive('code') },
            { name: 'Blockquote', icon: 'fa-solid fa-quote-left', command: () => editor.chain().focus().toggleBlockquote().run(), isActive: () => editor.isActive('blockquote') },
            { name: 'H1', icon: 'fa-solid fa-heading', command: () => editor.chain().focus().toggleHeading({ level: 1 }).run(), isActive: () => editor.isActive('heading', { level: 1 }) },
            { name: 'H2', icon: 'fa-solid fa-heading', command: () => editor.chain().focus().toggleHeading({ level: 2 }).run(), isActive: () => editor.isActive('heading', { level: 2 }) },
            { name: 'H3', icon: 'fa-solid fa-heading', command: () => editor.chain().focus().toggleHeading({ level: 3 }).run(), isActive: () => editor.isActive('heading', { level: 3 }) },
            { name: 'Bullet List', icon: 'fa-solid fa-list-ul', command: () => editor.chain().focus().toggleBulletList().run(), isActive: () => editor.isActive('bulletList') },
            { name: 'Ordered List', icon: 'fa-solid fa-list-ol', command: () => editor.chain().focus().toggleOrderedList().run(), isActive: () => editor.isActive('orderedList') },
            {
                name: 'Link',
                icon: 'fa-solid fa-link',
                command: () => {
                    const previousUrl = editor.getAttributes('link').href;
                    const url = prompt('링크 URL을 입력하세요:', previousUrl || '');

                    if (url === null) return;
                    if (url === '') {
                        editor.chain().focus().extendMarkRange('link').unsetLink().run();
                        return;
                    }
                    editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();
                },
                isActive: () => editor.isActive('link')
            },
            {
                name: 'Image',
                icon: 'fa-solid fa-image',
                command: async () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            try {
                                const base64 = await resizeImage(file, 720);
                                editor.chain().focus().setImage({ src: base64 }).run();
                            } catch (error) {
                                alert('이미지 처리 실패: ' + error.message);
                            }
                        }
                    };
                    input.click();
                }
            },
            { name: 'Align Left', icon: 'fa-solid fa-align-left', command: () => editor.chain().focus().setTextAlign('left').run() },
            { name: 'Align Center', icon: 'fa-solid fa-align-center', command: () => editor.chain().focus().setTextAlign('center').run() },
            { name: 'Align Right', icon: 'fa-solid fa-align-right', command: () => editor.chain().focus().setTextAlign('right').run() }
        ];

        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'p-2 hover:bg-gray-200 rounded transition';
            button.innerHTML = `<i class="${btn.icon}"></i>`;
            button.title = btn.name;
            button.onclick = (e) => {
                e.preventDefault();
                btn.command();
            };

            if (btn.isActive) {
                editor.on('selectionUpdate', () => {
                    button.classList.toggle('bg-blue-100', btn.isActive());
                });
                editor.on('transaction', () => {
                    button.classList.toggle('bg-blue-100', btn.isActive());
                });
            }

            toolbar.appendChild(button);
        });

        // Highlight with color palette
        const highlightWrapper = document.createElement('div');
        highlightWrapper.className = 'color-picker-wrapper p-2 hover:bg-gray-200 rounded transition cursor-pointer';
        highlightWrapper.title = 'Highlight Color';

        const highlightIcon = document.createElement('i');
        highlightIcon.className = 'fa-solid fa-highlighter';
        highlightWrapper.appendChild(highlightIcon);

        const highlightPalette = createColorPalette(highlightColors, (color) => {
            editor.chain().focus().toggleHighlight({ color }).run();
        });
        highlightWrapper.appendChild(highlightPalette);

        highlightWrapper.onclick = (e) => {
            e.stopPropagation();
            highlightPalette.classList.toggle('active');
            document.addEventListener('click', function closeHighlight() {
                highlightPalette.classList.remove('active');
                document.removeEventListener('click', closeHighlight);
            });
        };

        toolbar.appendChild(highlightWrapper);

        // Text color with palette
        const colorPickerWrapper = document.createElement('div');
        colorPickerWrapper.className = 'color-picker-wrapper p-2 hover:bg-gray-200 rounded transition cursor-pointer';
        colorPickerWrapper.title = 'Text Color';

        const colorIcon = document.createElement('i');
        colorIcon.className = 'fa-solid fa-palette';
        colorPickerWrapper.appendChild(colorIcon);

        const colorPalette = createColorPalette(textColors, (color) => {
            editor.chain().focus().setColor(color).run();
        });
        colorPickerWrapper.appendChild(colorPalette);

        colorPickerWrapper.onclick = (e) => {
            e.stopPropagation();
            colorPalette.classList.toggle('active');
            document.addEventListener('click', function closeColor() {
                colorPalette.classList.remove('active');
                document.removeEventListener('click', closeColor);
            });
        };

        toolbar.appendChild(colorPickerWrapper);
    }

    // ============================================
    // Editor Initialization
    // ============================================
    function initializeEditors() {
        const CustomImage = TiptapImage.extend({
            addAttributes() {
                return {
                    src: {
                        default: null,
                    },
                    alt: {
                        default: null,
                    },
                    title: {
                        default: null,
                    },
                }
            },
        });

        editorKor = new Editor({
            element: document.getElementById('editor-kor'),
            extensions: [
                StarterKit,
                CustomImage,
                Link.configure({
                    openOnClick: false,
                    HTMLAttributes: {
                        class: 'text-blue-500 underline',
                    },
                }),
                Underline,
                Highlight.configure({
                    multicolor: true
                }),
                TextAlign.configure({ types: ['heading', 'paragraph'] }),
                TextStyle,
                Color,
                Placeholder.configure({
                    placeholder: '한국어 내용을 입력하세요...'
                })
            ],
            content: '<p></p>'
        });

        editorEn = new Editor({
            element: document.getElementById('editor-en'),
            extensions: [
                StarterKit,
                CustomImage,
                Link.configure({
                    openOnClick: false,
                    HTMLAttributes: {
                        class: 'text-blue-500 underline',
                    },
                }),
                Underline,
                Highlight.configure({
                    multicolor: true
                }),
                TextAlign.configure({ types: ['heading', 'paragraph'] }),
                TextStyle,
                Color,
                Placeholder.configure({
                    placeholder: 'Enter English content...'
                })
            ],
            content: '<p></p>'
        });

        createToolbar(editorKor, 'toolbar-kor');
        createToolbar(editorEn, 'toolbar-en');
    }

    // ============================================
    // Load District Options
    // ============================================
    function loadDistrictOptions() {
        const select = document.getElementById('district-select');
        select.innerHTML = '<option value="">-- 지역을 선택하세요 --</option>';

        districtMeta.forEach(district => {
            const option = document.createElement('option');
            option.value = district.district_id;
            option.textContent = `${district.name_kor} (${district.name_en})`;
            select.appendChild(option);
        });
    }

    // ============================================
    // Mode Selection
    // ============================================
    document.getElementById('btn-edit-mode').addEventListener('click', () => {
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('edit-url-input').classList.remove('hidden');
        isEditMode = true;
    });

    document.getElementById('btn-create-mode').addEventListener('click', () => {
        document.getElementById('mode-selection').classList.add('hidden');
        document.getElementById('editor-form').classList.remove('hidden');
        document.getElementById('form-title').textContent = '새 콘텐츠 발행';
        document.getElementById('publish-btn-text').textContent = '발행하기';
        isEditMode = false;
    });

    document.getElementById('back-to-mode-select').addEventListener('click', () => {
        document.getElementById('edit-url-input').classList.add('hidden');
        document.getElementById('mode-selection').classList.remove('hidden');
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', () => {
        if (confirm('작업을 취소하고 처음으로 돌아가시겠습니까?')) {
            window.location.reload();
        }
    });

    // ============================================
    // Load Article from URL
    // ============================================
    document.getElementById('load-article-btn').addEventListener('click', async () => {
        const url = document.getElementById('article-url').value.trim();
        if (!url) {
            alert('URL을 입력해주세요.');
            return;
        }

        const urlParams = new URLSearchParams(new URL(url).search);
        const articleId = urlParams.get('id');

        if (!articleId) {
            alert('유효하지 않은 URL입니다. id 파라미터가 필요합니다.');
            return;
        }

        showProgress('게시글 불러오는 중...', 0);

        try {
            updateProgress('메타데이터 조회 중...', 30);
            const { data, error } = await supabaseClient
                .from('content_items')
                .select('*')
                .eq('id', articleId)
                .single();

            if (error) throw error;
            if (!data) throw new Error('게시글을 찾을 수 없습니다.');

            updateProgress('본문 조회 중...', 60);
            const { data: articleData, error: articleError } = await supabaseClient
                .from('articles')
                .select('*')
                .eq('id', articleId)
                .single();

            if (articleError) {
                console.warn('본문 조회 오류:', articleError);
            }

            updateProgress('데이터 로딩 중...', 80);

            document.getElementById('edit-article-id').value = data.id;
            document.getElementById('category').value = data.source_type;
            document.getElementById('title-kor').value = data.title_kor || '';
            document.getElementById('title-en').value = data.title_en || '';
            document.getElementById('desc-kor').value = data.desc_kor || '';
            document.getElementById('desc-en').value = data.desc_en || '';
            document.getElementById('subcategory').value = data.category || '';
            document.getElementById('author').value = data.author || '';
            document.getElementById('thumbnail-url').value = data.image || '';
            document.getElementById('cultural-badge').value = data.cultural_badge || '';
            document.getElementById('tags').value = data.tags ? data.tags.join(', ') : '';
            document.getElementById('district-select').value = data.district_id || '';

            uploadedThumbnailUrl = data.image;
            currentThumbnailFileName = `${articleId}.webp`;

            if (articleData) {
                if (articleData.article_html_ko) {
                    editorKor.commands.setContent(articleData.article_html_ko);
                }
                if (articleData.article_html_en) {
                    editorEn.commands.setContent(articleData.article_html_en);
                }
            }

            updateProgress('완료!', 100);

            setTimeout(() => {
                hideProgress();
                document.getElementById('edit-url-input').classList.add('hidden');
                document.getElementById('editor-form').classList.remove('hidden');
                document.getElementById('form-title').textContent = '게시글 수정';
                document.getElementById('publish-btn-text').textContent = '수정 완료';
                currentArticleId = articleId;
                isEditMode = true;
            }, 500);

        } catch (error) {
            hideProgress();
            console.error('❌ 로드 오류:', error);
            alert('게시글을 불러올 수 없습니다: ' + error.message);
        }
    });

    // ============================================
    // Upload Base64 Images to Supabase
    // ============================================
    async function uploadBase64Images(htmlContent, articleId) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const images = doc.querySelectorAll('img[src^="data:"]');

        let imageIndex = 1;
        const uploadPromises = [];

        for (const img of images) {
            const base64Src = img.getAttribute('src');
            const fileName = `${articleId}-${imageIndex}.webp`;

            const uploadPromise = (async () => {
                try {
                    const blob = base64ToBlob(base64Src);
                    const publicUrl = await uploadImageToSupabase(blob, fileName);
                    img.setAttribute('src', publicUrl);
                    console.log(`✅ Uploaded: ${fileName}`);
                } catch (error) {
                    console.error(`❌ Failed to upload ${fileName}:`, error);
                }
            })();

            uploadPromises.push(uploadPromise);
            imageIndex++;
        }

        await Promise.all(uploadPromises);

        return doc.body.innerHTML;
    }

    // ============================================
    // Publish/Update Article
    // ============================================
    document.getElementById('publish-btn').addEventListener('click', async () => {
        if (!confirm(isEditMode ? '게시글을 수정하시겠습니까?' : '게시글을 발행하시겠습니까?')) return;

        showProgress(isEditMode ? '수정 중...' : '발행 중...', 0);

        try {
            const category = document.getElementById('category').value;
            if (!category) {
                throw new Error('카테고리를 선택해주세요.');
            }

            const articleId = document.getElementById('edit-article-id').value || await generateArticleId(category);

            if (!document.getElementById('edit-article-id').value) {
                document.getElementById('edit-article-id').value = articleId;
            }

            updateProgress('이미지 업로드 중...', 20);

            const korHtml = editorKor.getHTML();
            const enHtml = editorEn.getHTML();

            const uploadedKorHtml = await uploadBase64Images(korHtml, articleId);
            const uploadedEnHtml = await uploadBase64Images(enHtml, articleId);

            updateProgress('데이터 저장 중...', 60);

            const contentData = {
                id: articleId,
                source_type: category,
                category: document.getElementById('subcategory').value,
                district_id: document.getElementById('district-select').value || null,
                cultural_badge: document.getElementById('cultural-badge').value || null,
                author: document.getElementById('author').value,
                date: new Date().toISOString().split('T')[0],
                title_kor: document.getElementById('title-kor').value,
                desc_kor: document.getElementById('desc-kor').value,
                title_en: document.getElementById('title-en').value,
                desc_en: document.getElementById('desc-en').value,
                image: uploadedThumbnailUrl || document.getElementById('thumbnail-url').value,
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(Boolean),
                views: 0
            };

            const articleData = {
                id: articleId,
                article_html_ko: uploadedKorHtml,
                article_html_en: uploadedEnHtml
            };

            await supabaseClient.from('content_items').upsert(contentData, { onConflict: 'id' });

            updateProgress('본문 저장 중...', 80);
            await supabaseClient.from('articles').upsert(articleData, { onConflict: 'id' });

            updateProgress('완료!', 100);
            setTimeout(() => {
                hideProgress();
                alert(isEditMode ? '게시글이 수정되었습니다!' : '게시글이 발행되었습니다!');
                window.location.reload();
            }, 500);

        } catch (error) {
            hideProgress();
            alert('저장 중 오류 발생: ' + error.message);
        }
    });

    // ============================================
    // Delete Article Modal
    // ============================================
    function showDeleteConfirmModal() {
        const articleId = document.getElementById('edit-article-id').value;
        if (!articleId) {
            alert('삭제할 게시글이 없습니다.');
            return;
        }

        const modal = document.createElement('div');
        modal.id = 'delete-confirm-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                <h3 class="text-xl font-bold mb-4 text-red-600">게시글 삭제</h3>
                <p class="text-gray-700 mb-4">
                    이 작업은 되돌릴 수 없습니다. 삭제하려면 아래 텍스트를 입력하세요:<br>
                    <strong class="text-red-600">I will delete this content</strong>
                </p>
                <input type="text" id="delete-confirm-input"
                       placeholder="확인 문구를 입력하세요"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-red-500">
                <div class="flex gap-3 justify-end">
                    <button onclick="closeDeleteModal()"
                            class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                        취소
                    </button>
                    <button onclick="confirmDeleteArticle()"
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        삭제
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    window.closeDeleteModal = function() {
        const modal = document.getElementById('delete-confirm-modal');
        if (modal) modal.remove();
    };

    window.confirmDeleteArticle = async function() {
        const confirmText = document.getElementById('delete-confirm-input').value;

        if (confirmText !== 'I will delete this content') {
            alert('확인 문구를 정확히 입력해주세요.');
            return;
        }

        const articleId = document.getElementById('edit-article-id').value;
        closeDeleteModal();
        showProgress('게시글 삭제 중...', 0);

        try {
            updateProgress('데이터 삭제 중...', 25);
            await supabaseClient.from('content_items').delete().eq('id', articleId);

            updateProgress('본문 삭제 중...', 50);
            await supabaseClient.from('articles').delete().eq('id', articleId);

            updateProgress('관련 데이터 삭제 중...', 75);
            await supabaseClient.from('featured_content').delete().eq('article_id', articleId);

            updateProgress('이미지 삭제 중...', 90);
            if (currentThumbnailFileName) {
                await deleteImageFromSupabase(currentThumbnailFileName);
            }

            for (let i = 1; i <= 50; i++) {
                await deleteImageFromSupabase(`${articleId}-${i}.webp`);
            }

            updateProgress('완료!', 100);
            setTimeout(() => {
                hideProgress();
                alert('게시글이 삭제되었습니다.');
                window.location.reload();
            }, 500);

        } catch (error) {
            hideProgress();
            alert('삭제 중 오류 발생: ' + error.message);
        }
    };

    // ============================================
    // Reset Form
    // ============================================
    function resetForm() {
        if (!confirm('모든 내용을 초기화하시겠습니까?')) return;

        document.getElementById('edit-article-id').value = '';
        document.getElementById('category').value = '';
        document.getElementById('title-kor').value = '';
        document.getElementById('title-en').value = '';
        document.getElementById('desc-kor').value = '';
        document.getElementById('desc-en').value = '';
        document.getElementById('subcategory').value = '';
        document.getElementById('author').value = '';
        document.getElementById('thumbnail-url').value = '';
        document.getElementById('cultural-badge').value = '';
        document.getElementById('tags').value = '';
        document.getElementById('district-select').value = '';

        if (editorKor) editorKor.commands.clearContent();
        if (editorEn) editorEn.commands.clearContent();

        uploadedThumbnailUrl = null;
        currentThumbnailFileName = null;
        isEditMode = false;
        currentArticleId = null;

        alert('폼이 초기화되었습니다.');
    }

    document.getElementById('delete-article-btn').addEventListener('click', showDeleteConfirmModal);
    document.getElementById('reset-form-btn').addEventListener('click', resetForm);

    // ============================================
    // Progress Modal Functions
    // ============================================
    function showProgress(message, percent) {
        document.getElementById('upload-overlay').classList.remove('hidden');
        document.getElementById('upload-progress').classList.remove('hidden');
        updateProgress(message, percent);
    }

    function updateProgress(message, percent) {
        document.getElementById('upload-status').textContent = message;
        document.getElementById('progress-fill').style.width = `${percent}%`;
        document.getElementById('upload-detail').textContent = `${Math.round(percent)}%`;
    }

    function hideProgress() {
        document.getElementById('upload-overlay').classList.add('hidden');
        document.getElementById('upload-progress').classList.add('hidden');
    }

    // ============================================
    // Logout
    // ============================================
    document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = '../admin/index.html';
    });

    // ============================================
    // Initialize on Load
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
        loadDistrictOptions();
        initializeEditors();
    });

</script>

</body>
</html>
