<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBC Content Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            word-break: keep-all;
        }
        .font-serif, .font-serif * {
            font-family: 'Noto Serif KR', Georgia, serif !important;
        }

        .ProseMirror {
            padding: 20px;
            min-height: 400px;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
        }
        .ProseMirror p { margin: 0.75em 0; }
        .ProseMirror h1 { font-size: 2em; font-weight: bold; margin: 1em 0 0.5em; line-height: 1.2; }
        .ProseMirror h2 { font-size: 1.5em; font-weight: bold; margin: 0.8em 0 0.4em; line-height: 1.3; }
        .ProseMirror h3 { font-size: 1.25em; font-weight: bold; margin: 0.6em 0 0.3em; line-height: 1.4; }
        .ProseMirror strong { font-weight: bold; }
        .ProseMirror em { font-style: italic; }
        .ProseMirror code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .ProseMirror img {
            max-width: 500px;
            height: auto;
            border-radius: 4px;
            margin: 1em 0;
            display: block;
        }
        .ProseMirror a {
            color: #3b82f6;
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- Upload Progress Modal -->
<div id="upload-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9998]"></div>
<div id="upload-progress" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-8 rounded-xl shadow-2xl z-[9999] min-w-[300px] text-center">
    <h3 class="text-lg font-bold mb-2">처리 중...</h3>
    <p id="upload-status" class="text-sm text-gray-600 mb-2">준비 중...</p>
    <div class="w-full h-2 bg-gray-200 rounded overflow-hidden mt-4">
        <div id="progress-fill" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
    </div>
    <p id="upload-detail" class="text-xs text-gray-500 mt-2"></p>
</div>

<!-- Header -->
<header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-3 items-center py-3 border-b">
            <div class="flex items-center space-x-4 text-xs">
                <button id="logout-btn" class="px-3 py-1 border border-gray-300 hover:bg-gray-100 transition">
                    로그아웃
                </button>
            </div>
            <div class="text-center">
                <a href="../index.html" class="hover:opacity-80 transition">
                    <h1 class="text-3xl font-serif font-bold tracking-wider">FBC</h1>
                </a>
            </div>
            <div class="flex items-center justify-end space-x-4 text-xs">
                <span class="text-gray-600">Admin Editor</span>
            </div>
        </div>
    </div>
</header>

<!-- Main Container -->
<div class="max-w-[1200px] mx-auto px-5 py-10">

    <!-- Mode Selection - Admin Style -->
    <div id="mode-selection" class="min-h-[80vh] flex items-center justify-center px-4">
        <div class="w-full max-w-md">

            <!-- Logo & Title -->
            <div class="text-center mb-8">
                <h1 class="text-5xl font-serif font-bold tracking-wider mb-2">FBC</h1>
                <p class="text-sm text-gray-600 tracking-widest uppercase">Content Editor</p>
            </div>

            <!-- Selection Card -->
            <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-8">

                <h2 class="text-xl font-semibold text-center mb-6">
                    작업 선택
                </h2>

                <p class="text-sm text-gray-600 text-center mb-8">
                    어떤 작업을 하시겠습니까?
                </p>

                <!-- Buttons -->
                <div class="space-y-4">
                    <button
                            id="btn-edit-mode"
                            class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition"
                    >
                        기존 게시글 수정
                    </button>

                    <button
                            id="btn-create-mode"
                            class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition"
                    >
                        새로운 글 발행
                    </button>
                </div>

            </div>

            <!-- Footer -->
            <div class="text-center mt-8">
                <a href="../index.html" class="text-sm text-gray-600 hover:text-black transition">
                    ← 메인으로 돌아가기
                </a>
            </div>

        </div>
    </div>

    <!-- Edit Mode: URL Input - Admin Style -->
    <div id="edit-url-input" class="hidden min-h-[80vh] flex items-center justify-center px-4">
        <div class="w-full max-w-md">

            <!-- Logo & Title -->
            <div class="text-center mb-8">
                <h1 class="text-5xl font-serif font-bold tracking-wider mb-2">FBC</h1>
                <p class="text-sm text-gray-600 tracking-widest uppercase">Edit Article</p>
            </div>

            <!-- URL Input Card -->
            <div class="bg-white shadow-sm border border-gray-200 rounded-lg p-8">

                <h2 class="text-xl font-semibold mb-2">게시글 URL 입력</h2>
                <p class="text-sm text-gray-600 mb-6">
                    수정할 게시글의 URL을 입력해주세요.
                </p>

                <div class="space-y-6">
                    <div>
                        <label for="article-url" class="block text-sm font-medium text-gray-700 mb-2">
                            게시글 URL
                        </label>
                        <input
                                type="text"
                                id="article-url"
                                class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition text-sm"
                                placeholder="http://localhost:8000/article/index.html?category=fashion&id=fs00001"
                        >
                    </div>

                    <button
                            id="load-article-btn"
                            class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition"
                    >
                        불러오기
                    </button>
                </div>

            </div>

            <!-- Footer -->
            <div class="text-center mt-8">
                <button
                        id="back-to-mode-select"
                        class="text-sm text-gray-600 hover:text-black transition"
                >
                    ← 작업 선택으로 돌아가기
                </button>
            </div>

        </div>
    </div>

    <!-- Editor Form -->
    <div id="editor-form" class="hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold" id="form-title">새 콘텐츠 발행</h1>
            <button id="cancel-edit-btn" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 transition">
                취소
            </button>
        </div>

        <input type="hidden" id="edit-article-id" value="">

        <!-- Category Selection -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">카테고리 선택 *</label>
            <select id="category" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" required>
                <option value="">-- 카테고리를 선택하세요 --</option>
                <option value="fashion">Fashion</option>
                <option value="beauty">Beauty</option>
                <option value="life">Life</option>
                <option value="districts">Districts</option>
            </select>
        </div>

        <!-- Title Inputs -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block font-semibold mb-2 text-sm">제목 (한국어) *</label>
                <input type="text" id="title-kor" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="한국어 제목" required>
            </div>
            <div>
                <label class="block font-semibold mb-2 text-sm">제목 (English) *</label>
                <input type="text" id="title-en" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="English title" required>
            </div>
        </div>

        <!-- Description Inputs -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block font-semibold mb-2 text-sm">설명 (한국어) *</label>
                <input type="text" id="desc-kor" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="한국어 설명" required>
            </div>
            <div>
                <label class="block font-semibold mb-2 text-sm">설명 (English) *</label>
                <input type="text" id="desc-en" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="English description" required>
            </div>
        </div>

        <!-- Additional Fields -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block font-semibold mb-2 text-sm">카테고리 세부 * (영어/숫자만)</label>
                    <input type="text" id="subcategory" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="예: Fashion Item" required>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">작성자 * (영어/숫자만)</label>
                    <input type="text" id="author" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="Author name" required>
                </div>
                <div class="md:col-span-2">
                    <label class="block font-semibold mb-2 text-sm">썸네일 이미지 URL *</label>
                    <input type="text" id="thumbnail-url" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="https://..." required>
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">Cultural Badge (선택, 영어/숫자만)</label>
                    <input type="text" id="cultural-badge" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="예: Industrial Chic">
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">태그 (쉼표로 구분, 영어/숫자만)</label>
                    <input type="text" id="tags" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm" placeholder="tag1, tag2, tag3">
                </div>
                <div>
                    <label class="block font-semibold mb-2 text-sm">관련 지역 (선택)</label>
                    <select id="district-select" class="w-full px-3 py-2.5 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-sm">
                        <option value="">-- 지역을 선택하세요 --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Content Editor (Korean) -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">본문 내용 (한국어) *</label>
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <div id="toolbar-kor" class="border-b border-gray-200 p-2 flex gap-1 flex-wrap bg-gray-50"></div>
                <div id="editor-kor"></div>
            </div>
        </div>

        <!-- Content Editor (English) -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
            <label class="block font-semibold mb-2 text-sm">본문 내용 (English) *</label>
            <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
                <div id="toolbar-en" class="border-b border-gray-200 p-2 flex gap-1 flex-wrap bg-gray-50"></div>
                <div id="editor-en"></div>
            </div>
        </div>

        <!-- Publish Button -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 text-center">
            <button id="publish-btn" class="px-8 py-3 bg-black text-white rounded hover:bg-gray-800 transition font-semibold">
                <span id="publish-btn-text">발행하기</span>
            </button>
            <p id="publish-info" class="text-sm text-gray-600 mt-4">
                <span id="publish-info-text">발행하면 Supabase에 데이터가 저장됩니다.</span>
            </p>
        </div>
    </div>

</div>

<script type="module">
    /**
     * @fileoverview FBC Content Editor with Supabase Integration
     * @description Admin panel for creating and editing content
     */

    import { Editor } from 'https://esm.sh/@tiptap/core@2.10.3'
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.10.3'
    import TiptapImage from 'https://esm.sh/@tiptap/extension-image@2.10.3'
    import Link from 'https://esm.sh/@tiptap/extension-link@2.10.3'
    import Highlight from 'https://esm.sh/@tiptap/extension-highlight@2.10.3'
    import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder@2.10.3'

    // ============================================
    // Supabase Configuration
    // ============================================
    const SUPABASE_URL = 'https://ipcibnhhegkhdwyxeqjs.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your anon key

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // Global State
    // ============================================
    /** @type {Editor|null} */
    let editorKor = null;

    /** @type {Editor|null} */
    let editorEn = null;

    /** @type {boolean} */
    let isEditMode = false;

    /** @type {Array<{district_id: string, name_kor: string, name_en: string}>} */
    const districtMeta = [
        { district_id: "dsm00001", name_kor: "성수동", name_en: "Seongsu-dong" },
        { district_id: "dsm00002", name_kor: "한남동", name_en: "Hannam-dong" },
        { district_id: "dsm00003", name_kor: "홍대", name_en: "Hongdae" },
        { district_id: "dsm00004", name_kor: "명동", name_en: "Myeongdong" }
    ];

    // ============================================
    // Toolbar Icons
    // ============================================
    const icons = {
        bold: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 2.5C5.17157 2.5 4.5 3.17157 4.5 4V20C4.5 20.8284 5.17157 21.5 6 21.5H15C16.4587 21.5 17.8576 20.9205 18.8891 19.8891C19.9205 18.8576 20.5 17.4587 20.5 16C20.5 14.5413 19.9205 13.1424 18.8891 12.1109C18.6781 11.9 18.4518 11.7079 18.2128 11.5359C19.041 10.5492 19.5 9.29829 19.5 8C19.5 6.54131 18.9205 5.14236 17.8891 4.11091C16.8576 3.07946 15.4587 2.5 14 2.5H6ZM14 10.5C14.663 10.5 15.2989 10.2366 15.7678 9.76777C16.2366 9.29893 16.5 8.66304 16.5 8C16.5 7.33696 16.2366 6.70107 15.7678 6.23223C15.2989 5.76339 14.663 5.5 14 5.5H7.5V10.5H14ZM7.5 18.5V13.5H15C15.663 13.5 16.2989 13.7634 16.7678 14.2322C17.2366 14.7011 17.5 15.337 17.5 16C17.5 16.663 17.2366 17.2989 16.7678 17.7678C16.2989 18.2366 15.663 18.5 15 18.5H7.5Z"/></svg>',
        italic: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M15.0222 3H19C19.5523 3 20 3.44772 20 4C20 4.55228 19.5523 5 19 5H15.693L10.443 19H14C14.5523 19 15 19.4477 15 20C15 20.5523 14.5523 21 14 21H9.02418C9.00802 21.0004 8.99181 21.0004 8.97557 21H5C4.44772 21 4 20.5523 4 20C4 19.4477 4.44772 19 5 19H8.30704L13.557 5H10C9.44772 5 9 4.55228 9 4C9 3.44772 9.44772 3 10 3H14.9782C14.9928 2.99968 15.0075 2.99967 15.0222 3Z"/></svg>',
        image: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M20 2C20 1.44772 19.5523 1 19 1C18.4477 1 18 1.44772 18 2V4H16C15.4477 4 15 4.44772 15 5C15 5.55228 15.4477 6 16 6H18V8C18 8.55228 18.4477 9 19 9C19.5523 9 20 8.55228 20 8V6H22C22.5523 6 23 5.55228 23 5C23 4.44772 22.5523 4 22 4H20V2Z"/></svg>'
    };

    // ============================================
    // Utility Functions
    // ============================================

    /**
     * Show/hide progress modal
     * @param {boolean} show - Show or hide
     */
    function showProgress(show = true) {
        document.getElementById('upload-overlay').classList.toggle('hidden', !show);
        document.getElementById('upload-progress').classList.toggle('hidden', !show);
    }

    /**
     * Update progress
     * @param {number} percent - Progress percentage
     * @param {string} status - Status message
     * @param {string} detail - Detail message
     */
    function updateProgress(percent, status, detail = '') {
        document.getElementById('progress-fill').style.width = `${percent}%`;
        document.getElementById('upload-status').textContent = status;
        document.getElementById('upload-detail').textContent = detail;
    }

    /**
     * Show/hide elements
     * @param {string} showId - Element ID to show
     */
    function showSection(showId) {
        ['mode-selection', 'edit-url-input', 'editor-form'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(showId).classList.remove('hidden');
    }

    /**
     * Extract URL parameters
     * @param {string} url - URL string
     * @returns {{category: string|null, id: string|null}}
     */
    function extractUrlParams(url) {
        try {
            const urlObj = new URL(url);
            const params = new URLSearchParams(urlObj.search);
            return {
                category: params.get('category'),
                id: params.get('id')
            };
        } catch (error) {
            console.error('URL parsing error:', error);
            return { category: null, id: null };
        }
    }

    /**
     * Generate next article ID
     * @param {string} category - Category name
     * @returns {Promise<string>}
     */
    async function generateNextId(category) {
        const prefix = { fashion: 'fs', beauty: 'by', life: 'lf', districts: 'ds' }[category];

        try {
            const { data, error } = await supabaseClient
                .from('content_items')
                .select('id')
                .eq('source_type', category)
                .order('id', { ascending: false })
                .limit(1);

            if (error) throw error;

            if (data && data.length > 0) {
                const lastId = data[0].id;
                const match = lastId.match(/\d+$/);
                const num = match ? parseInt(match[0]) + 1 : 1;
                return `${prefix}${String(num).padStart(5, '0')}`;
            }

            return `${prefix}00001`;
        } catch (error) {
            console.error('ID generation error:', error);
            return `${prefix}00001`;
        }
    }

    // ============================================
    // Editor Initialization
    // ============================================

    /**
     * Create toolbar for editor
     * @param {Editor} editor - Tiptap editor instance
     * @param {string} toolbarId - Toolbar element ID
     */
    function createToolbar(editor, toolbarId) {
        const toolbar = document.getElementById(toolbarId);

        const buttons = [
            { name: 'Bold', icon: icons.bold, command: () => editor.chain().focus().toggleBold().run(), isActive: () => editor.isActive('bold') },
            { name: 'Italic', icon: icons.italic, command: () => editor.chain().focus().toggleItalic().run(), isActive: () => editor.isActive('italic') },
        ];

        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = 'p-1.5 rounded hover:bg-gray-200 transition flex items-center justify-center min-w-[36px] min-h-[36px]';
            button.innerHTML = btn.icon;
            button.title = btn.name;
            button.type = 'button';
            button.onclick = btn.command;

            if (btn.isActive) {
                const updateState = () => button.classList.toggle('bg-gray-200', btn.isActive());
                editor.on('selectionUpdate', updateState);
                editor.on('update', updateState);
                updateState();
            }
            toolbar.appendChild(button);
        });

        // Image button
        const imageBtn = document.createElement('button');
        imageBtn.className = 'p-1.5 rounded hover:bg-gray-200 transition flex items-center justify-center min-w-[36px] min-h-[36px]';
        imageBtn.innerHTML = icons.image;
        imageBtn.title = 'Add image URL';
        imageBtn.type = 'button';
        imageBtn.onclick = () => {
            const url = window.prompt('이미지 URL을 입력하세요:');
            if (url) {
                editor.chain().focus().setImage({ src: url }).run();
            }
        };
        toolbar.appendChild(imageBtn);
    }

    /**
     * Initialize Tiptap editors
     */
    function initializeEditors() {
        const extensions = [
            StarterKit,
            TiptapImage.configure({ inline: false }),
            Link.configure({ openOnClick: false }),
            Highlight.configure({ multicolor: false })
        ];

        editorKor = new Editor({
            element: document.querySelector('#editor-kor'),
            extensions: [...extensions, Placeholder.configure({ placeholder: '한국어 본문을 입력하세요...' })],
            content: '',
        });

        editorEn = new Editor({
            element: document.querySelector('#editor-en'),
            extensions: [...extensions, Placeholder.configure({ placeholder: 'Enter English content...' })],
            content: '',
        });

        createToolbar(editorKor, 'toolbar-kor');
        createToolbar(editorEn, 'toolbar-en');
    }

    // ============================================
    // Auth Check
    // ============================================

    /**
     * Check if user is authenticated
     */
    async function checkAuth() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (!session?.user) {
                alert('로그인이 필요합니다.');
                window.location.href = '/admin.html';
            }
        } catch (error) {
            console.error('Auth check error:', error);
            window.location.href = '/admin.html';
        }
    }

    // ============================================
    // Load Article for Editing
    // ============================================

    /**
     * Load article data from Supabase
     * @param {string} category - Category name
     * @param {string} articleId - Article ID
     */
    async function loadArticle(category, articleId) {
        try {
            showProgress(true);
            updateProgress(20, '게시글 정보 불러오는 중...');

            // Load content_items
            const { data: contentData, error: contentError } = await supabaseClient
                .from('content_items')
                .select('*')
                .eq('id', articleId)
                .single();

            if (contentError) throw contentError;

            updateProgress(50, 'HTML 콘텐츠 불러오는 중...');

            // Load articles
            const { data: articleData, error: articleError } = await supabaseClient
                .from('articles')
                .select('*')
                .eq('id', articleId)
                .single();

            if (articleError) throw articleError;

            updateProgress(80, '폼 데이터 채우는 중...');

            // Fill form
            document.getElementById('edit-article-id').value = articleId;
            document.getElementById('category').value = contentData.source_type;
            document.getElementById('title-kor').value = contentData.title_kor;
            document.getElementById('title-en').value = contentData.title_en;
            document.getElementById('desc-kor').value = contentData.desc_kor || '';
            document.getElementById('desc-en').value = contentData.desc_en || '';
            document.getElementById('subcategory').value = contentData.category;
            document.getElementById('author').value = contentData.author || '';
            document.getElementById('thumbnail-url').value = contentData.image || '';
            document.getElementById('cultural-badge').value = contentData.cultural_badge || '';
            document.getElementById('tags').value = (contentData.tags || []).join(', ');
            document.getElementById('district-select').value = contentData.district_id || '';

            // Set editor content
            editorKor.commands.setContent(articleData.article_html_ko);
            editorEn.commands.setContent(articleData.article_html_en);

            // Update UI
            document.getElementById('form-title').textContent = '게시글 수정';
            document.getElementById('publish-btn-text').textContent = '수정 완료';
            document.getElementById('publish-info-text').textContent = '수정 사항이 Supabase에 저장됩니다.';

            isEditMode = true;
            updateProgress(100, '완료!');
            setTimeout(() => {
                showProgress(false);
                showSection('editor-form');
            }, 500);

        } catch (error) {
            console.error('Load article error:', error);
            showProgress(false);
            alert('게시글을 불러오는 중 오류가 발생했습니다: ' + error.message);
        }
    }

    // ============================================
    // Publish/Update Article
    // ============================================

    /**
     * Publish or update article
     */
    async function publishArticle() {
        const category = document.getElementById('category').value;
        const titleKor = document.getElementById('title-kor').value;
        const titleEn = document.getElementById('title-en').value;
        const descKor = document.getElementById('desc-kor').value;
        const descEn = document.getElementById('desc-en').value;
        const subcategory = document.getElementById('subcategory').value;
        const author = document.getElementById('author').value;
        const thumbnailUrl = document.getElementById('thumbnail-url').value;
        const culturalBadge = document.getElementById('cultural-badge').value || null;
        const tagsInput = document.getElementById('tags').value;
        const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(Boolean) : [];
        const districtId = document.getElementById('district-select').value || null;

        // Validation
        if (!category) return alert('카테고리를 선택해주세요.');
        if (!titleKor || !titleEn) return alert('제목을 모두 입력해주세요.');
        if (!descKor || !descEn) return alert('설명을 모두 입력해주세요.');
        if (!subcategory) return alert('카테고리 세부를 입력해주세요.');
        if (!author) return alert('작성자를 입력해주세요.');
        if (!thumbnailUrl) return alert('썸네일 URL을 입력해주세요.');

        const contentKor = editorKor.getHTML();
        const contentEn = editorEn.getHTML();

        if (!contentKor || contentKor === '<p></p>') return alert('한국어 본문을 작성해주세요.');
        if (!contentEn || contentEn === '<p></p>') return alert('영어 본문을 작성해주세요.');

        const editArticleId = document.getElementById('edit-article-id').value;
        const articleId = editArticleId || await generateNextId(category);
        const today = new Date().toISOString().split('T')[0];

        try {
            showProgress(true);
            updateProgress(20, isEditMode ? '게시글 업데이트 중...' : '게시글 생성 중...');

            // Prepare content_items data
            const contentData = {
                id: articleId,
                source_type: category,
                district_id: districtId,
                title_kor: titleKor,
                title_en: titleEn,
                desc_kor: descKor,
                desc_en: descEn,
                category: subcategory,
                image: thumbnailUrl,
                tags: tags,
                cultural_badge: culturalBadge,
                date: today,
                author: author,
                views: 0
            };

            // Prepare articles data
            const articleData = {
                id: articleId,
                article_html_ko: contentKor,
                article_html_en: contentEn
            };

            updateProgress(50, 'content_items 저장 중...');

            // Upsert content_items
            const { error: contentError } = await supabaseClient
                .from('content_items')
                .upsert(contentData, { onConflict: 'id' });

            if (contentError) throw contentError;

            updateProgress(75, 'articles 저장 중...');

            // Upsert articles
            const { error: articleError } = await supabaseClient
                .from('articles')
                .upsert(articleData, { onConflict: 'id' });

            if (articleError) throw articleError;

            updateProgress(100, '완료!');

            setTimeout(() => {
                showProgress(false);
                alert(isEditMode ? '게시글이 수정되었습니다!' : '게시글이 발행되었습니다!');
                location.reload();
            }, 1000);

        } catch (error) {
            console.error('Publish error:', error);
            showProgress(false);
            alert('발행 중 오류가 발생했습니다: ' + error.message);
        }
    }

    // ============================================
    // Event Listeners
    // ============================================

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = '/admin.html';
    });

    // Mode selection buttons
    document.getElementById('btn-edit-mode').addEventListener('click', () => {
        showSection('edit-url-input');
    });

    document.getElementById('btn-create-mode').addEventListener('click', () => {
        isEditMode = false;
        document.getElementById('form-title').textContent = '새 콘텐츠 발행';
        document.getElementById('publish-btn-text').textContent = '발행하기';
        document.getElementById('publish-info-text').textContent = '발행하면 Supabase에 데이터가 저장됩니다.';
        showSection('editor-form');
    });

    // Back to mode selection
    document.getElementById('back-to-mode-select').addEventListener('click', () => {
        showSection('mode-selection');
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', () => {
        if (confirm('작성 중인 내용이 사라집니다. 계속하시겠습니까?')) {
            location.reload();
        }
    });

    // Load article
    document.getElementById('load-article-btn').addEventListener('click', () => {
        const url = document.getElementById('article-url').value.trim();
        if (!url) {
            alert('URL을 입력해주세요.');
            return;
        }

        const { category, id } = extractUrlParams(url);

        if (!category || !id) {
            alert('올바른 게시글 URL이 아닙니다.\n예: http://localhost:8000/article/index.html?category=fashion&id=fs00001');
            return;
        }

        loadArticle(category, id);
    });

    // Publish button
    document.getElementById('publish-btn').addEventListener('click', publishArticle);

    // Input validation (English/numbers only)
    ['subcategory', 'author', 'cultural-badge', 'tags'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                this.value = this.value.replace(/[^A-Za-z0-9\s,\-]/g, '');
            });
        }
    });

    // ============================================
    // Initialize
    // ============================================

    // Populate districts
    districtMeta.forEach(district => {
        const option = document.createElement('option');
        option.value = district.district_id;
        option.textContent = district.name_kor;
        document.getElementById('district-select').appendChild(option);
    });

    // Initialize editors
    initializeEditors();

    // Check authentication
    checkAuth();

</script>

</body>
</html>
