<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBC Creators Magazine</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Serif+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
        }
        .font-serif, .font-serif * {
            font-family: 'Noto Serif KR', Georgia, serif !important;
        }

        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }

        .skeleton {
            animation: shimmer 1.2s ease-in-out infinite;
            background: linear-gradient(to right, #f0f0f0 8%, #e0e0e0 18%, #f0f0f0 33%);
            background-size: 800px 104px;
        }

        .image-container {
            position: relative;
            overflow: hidden;
        }

        .image-container img {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .image-container img.loaded {
            opacity: 1;
        }

        /* 기존 CSS에 추가 */
        .hero-image-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .hero-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .hero-image.loaded {
            opacity: 1;
        }

        /* 로딩 애니메이션 */
        .hero-image-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.3) 50%,
                rgba(255,255,255,0) 100%
            );
            animation: shimmer 2s infinite;
        }

        .hero-image.loaded + .hero-image-container::before {
            display: none;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .hero-slide {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
        }

        .hero-slide.active {
            opacity: 1;
        }

        .hero-content {
            word-break: keep-all;
            text-wrap: balance;
        }

        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-white">

<!-- Header -->
<header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-3 items-center py-3 border-b">
            <div class="flex items-center space-x-4 text-xs">
                <button id="lang-toggle" class="px-3 py-1 border border-gray-300 hover:bg-gray-100 transition">
                    <span id="lang-text">English</span>
                </button>
            </div>
            <div class="justify-self-center">
                <a href="index.html" class="hover:opacity-80 transition">
                    <h1 class="text-3xl font-serif font-bold tracking-wider">FBC</h1>
                </a>
            </div>
            <div class="justify-self-end flex items-center space-x-4 text-xs">
                <a href="#newsletter-section" class="hover:text-gray-600">SUBSCRIBE</a>
                <a href="admin/index.html" class="opacity-60 hover:opacity-90 transition-opacity" title="Admin">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-gray-400">
                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                    </svg>
                </a>

            </div>
        </div>
        <nav class="py-4">
            <ul class="flex items-center justify-center space-x-6 md:space-x-8 text-sm font-medium">
                <li><a href="fashion/index.html" class="hover:text-gray-600 transition">FASHION</a></li>
                <li><a href="beauty/index.html" class="hover:text-gray-600 transition">BEAUTY</a></li>
                <li><a href="life/index.html" class="hover:text-gray-600 transition">LIFE</a></li>
                <li><a href="districts/index.html" class="hover:text-gray-600 transition">DISTRICTS</a></li>
            </ul>
        </nav>
    </div>
</header>

<!-- Hero Section -->
<section class="hero-image flex items-center justify-center text-white relative" id="hero-section">
    <div id="hero-slides-container" class="absolute inset-0"></div>
    <div class="hero-content absolute bottom-12 md:bottom-16 left-1/2 -translate-x-1/2 text-center px-4 md:px-8 z-10 w-full max-w-4xl">
        <h2 class="text-2xl md:text-4xl lg:text-5xl font-serif font-bold mb-2" id="hero-title"></h2>
        <p class="text-sm md:text-base opacity-90" id="hero-subtitle"></p>
    </div>
    <div class="absolute bottom-6 md:bottom-8 left-1/2 -translate-x-1/2 flex gap-2 md:gap-3 z-20" id="hero-indicators"></div>
</section>

<!-- Location Section -->
<section class="bg-gradient-to-b from-gray-50 to-gray-100 border-y border-gray-200 py-12 md:py-16">
    <div class="max-w-7xl mx-auto px-4 text-center">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4" id="location-title"></h2>
        <p class="text-base md:text-lg text-gray-600 max-w-2xl mx-auto mb-6" id="location-desc"></p>
        <button id="change-location" class="px-6 py-2 bg-black text-white font-semibold rounded hover:bg-gray-800 transition">
            📍 Change Location
        </button>
    </div>
</section>

<!-- Fashion Section -->
<section class="max-w-7xl mx-auto px-4 py-12 md:py-16">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-sm font-bold uppercase tracking-widest border-b-2 border-black pb-2" id="fashion-location-title">Fashion</h2>
        <a href="fashion/index.html" class="text-sm hover:underline">View All →</a>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="fashion-grid"></div>
</section>

<!-- Beauty Section -->
<section class="max-w-7xl mx-auto px-4 pb-12 md:pb-16">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-sm font-bold uppercase tracking-widest border-b-2 border-black pb-2" id="beauty-location-title">Beauty</h2>
        <a href="beauty/index.html" class="text-sm hover:underline">View All →</a>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="beauty-grid"></div>
</section>

<!-- Today's Stories -->
<section class="max-w-7xl mx-auto px-4 pb-12 md:pb-16">
    <h2 class="text-sm font-bold uppercase tracking-widest border-b-2 border-black pb-2 mb-6">Today's Stories</h2>
    <div class="grid grid-cols-1 md:grid-cols-12 gap-6" id="today-stories"></div>
</section>

<!-- Best Stories -->
<section class="max-w-7xl mx-auto px-4 pb-12 md:pb-16">
    <h2 class="text-sm font-bold uppercase tracking-widest border-b-2 border-black pb-2 mb-6">Best Stories</h2>
    <div class="swiper best-stories-swiper overflow-hidden -mx-4 px-4">
        <div class="swiper-wrapper" id="best-stories"></div>
    </div>
</section>

<!-- Must Read -->
<section class="max-w-7xl mx-auto px-4 pb-12 md:pb-16">
    <h2 class="text-sm font-bold uppercase tracking-widest border-b-2 border-black pb-2 mb-6">Must Read</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="must-read"></div>
</section>

<!-- Latest Stories -->
<section class="max-w-7xl mx-auto px-4 pb-12 md:pb-16">
    <h2 class="text-sm font-bold uppercase tracking-widest border-b-2 border-black pb-2 mb-6">Latest Stories</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="latest-stories"></div>
</section>

<!-- Footer -->
<footer class="bg-black text-white py-12">
    <div class="max-w-7xl mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <div>
                <h3 class="font-serif text-2xl font-bold mb-4">FBC</h3>
                <p class="text-sm text-gray-400">Fashion, Beauty, Culture<br>with Cultural Translation</p>
            </div>
            <div>
                <h4 class="font-bold mb-3 text-sm">CATEGORIES</h4>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li><a href="fashion/index.html" class="hover:text-white">Fashion</a></li>
                    <li><a href="beauty/index.html" class="hover:text-white">Beauty</a></li>
                    <li><a href="life/index.html" class="hover:text-white">Life & Culture</a></li>
                    <li><a href="districts/index.html" class="hover:text-white">Districts</a></li>
                </ul>
            </div>
            <div>
                <h4 class="font-bold mb-3 text-sm">ABOUT</h4>
                <ul class="space-y-2 text-sm text-gray-400">
                    <li><a href="about/index.html" class="hover:text-white">About FBC</a></li>
                </ul>
            </div>
            <div id="newsletter-section">
                <h4 class="font-bold mb-3 text-sm">NEWSLETTER</h4>
                <p class="text-sm text-gray-400 mb-3">Get weekly K-fashion insights</p>
                <div class="flex">
                    <input type="email" id="newsletter-email" placeholder="Your email" class="px-3 py-2 bg-gray-800 text-sm flex-1 focus:outline-none">
                    <button id="newsletter-submit" class="px-4 py-2 bg-white text-black text-sm font-medium">→</button>
                </div>
            </div>
        </div>
        <div class="border-t border-gray-800 pt-6 text-center text-xs text-gray-500">
            © 2025 FBC Creators. All rights reserved.
        </div>
    </div>
</footer>

<!-- Location Modal -->
<div id="location-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">Select Your Location</h3>
        <div class="space-y-3" id="location-options"></div>
        <button id="close-location-modal" class="mt-4 w-full py-2 bg-gray-200 rounded hover:bg-gray-300 transition">Cancel</button>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script type="module">
    // ============================================
    // Supabase Configuration
    // ============================================
    const SUPABASE_URL = window.ENV.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.ENV.SUPABASE_ANON_KEY;

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // State Management
    // ============================================
    const state = {
        currentLang: 'en',
        currentDistrict: 'dsm00001',
        currentHeroIndex: 0,
        heroInterval: null,
        heroSlides: [],
        autoSelectEnabled: true,
        data: {
            allContent: [],
            districtMeta: [
                { district_id: "dsm00001", name_kor: "성수동", name_en: "Seongsu-dong", title_kor: "성수동", title_en: "Seongsu-dong", desc_kor: "트렌디한 카페와 힙한 패션", desc_en: "Trendy cafes and hip fashion", latitude: 37.5447, longitude: 127.0557 },
                { district_id: "dsm00002", name_kor: "한남동", name_en: "Hannam-dong", title_kor: "한남동", title_en: "Hannam-dong", desc_kor: "럭셔리 브랜드와 고급 문화", desc_en: "Luxury brands and upscale culture", latitude: 37.5347, longitude: 127.0024 },
                { district_id: "dsm00003", name_kor: "홍대", name_en: "Hongdae", title_kor: "홍대", title_en: "Hongdae", desc_kor: "예술과 젊음의 거리", desc_en: "Street of art and youth", latitude: 37.5563, longitude: 126.9236 },
                { district_id: "dsm00004", name_kor: "명동", name_en: "Myeongdong", title_kor: "명동", title_en: "Myeongdong", desc_kor: "K-뷰티와 쇼핑의 중심", desc_en: "K-beauty and shopping hub", latitude: 37.5636, longitude: 126.9826 }
            ],
            heroIds: [],
            todayStoriesIds: [],
            mustReadIds: []
        }
    };

    // ============================================
    // Utility Functions
    // ============================================
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return state.currentLang === 'kor'
            ? date.toLocaleDateString('ko-KR', options)
            : date.toLocaleDateString('en-US', options);
    };

    const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    };

    const getContentById = (id) => state.data.allContent.find(item => item.id === id);
    const getDistrictMeta = (districtId) => state.data.districtMeta.find(d => d.district_id === districtId);

    function createImageWithSkeleton(src, alt, classes = '') {
        return `
            <div class="image-container w-full h-full">
                <div class="skeleton w-full h-full absolute inset-0"></div>
                <img src="${src}"
                     alt="${alt}"
                     class="${classes}"
                     loading="lazy"
                     onload="this.classList.add('loaded'); this.previousElementSibling?.remove();"
                     onerror="this.src='https://placehold.co/800x600/e5e5e5/666666?text=FBC'; this.classList.add('loaded'); this.previousElementSibling?.remove();">
            </div>
        `;
    }

    const createSkeletonCard = () => `
        <div class="animate-pulse">
            <div class="h-64 bg-gray-200 rounded-sm mb-3"></div>
            <div class="h-3 bg-gray-200 rounded w-1/3 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-full"></div>
        </div>
    `;

    // ============================================
    // Session Management
    // ============================================
    function loadSession() {
        const stored = sessionStorage;

        if (stored.getItem('fbc_language')) {
            state.currentLang = stored.getItem('fbc_language');
            document.getElementById('lang-text').textContent = state.currentLang === 'kor' ? '한국어' : 'English';
        } else {
            const browserLang = navigator.language || navigator.userLanguage;
            state.currentLang = browserLang.toLowerCase().includes('ko') ? 'kor' : 'en';
            document.getElementById('lang-text').textContent = state.currentLang === 'kor' ? '한국어' : 'English';
        }

        if (stored.getItem('autoSelectEnabled')) {
            state.autoSelectEnabled = stored.getItem('autoSelectEnabled') === 'true';
        }

        if (stored.getItem('currentDistrict')) {
            state.currentDistrict = stored.getItem('currentDistrict');
        }
    }

    function saveSession() {
        // ✅ fbc_language 키 사용
        sessionStorage.setItem('fbc_language', state.currentLang);
        sessionStorage.setItem('autoSelectEnabled', state.autoSelectEnabled);
        sessionStorage.setItem('currentDistrict', state.currentDistrict);
    }

    // ============================================
    // Show Skeletons
    // ============================================
    function showSkeletons() {
        document.getElementById('fashion-grid').innerHTML = Array(4).fill(createSkeletonCard()).join('');
        document.getElementById('beauty-grid').innerHTML = Array(4).fill(createSkeletonCard()).join('');
        document.getElementById('today-stories').innerHTML = '<div class="md:col-span-12 h-96 bg-gray-200 rounded-sm animate-pulse"></div>';
        document.getElementById('best-stories').innerHTML = Array(15).fill('<div class="swiper-slide" style="width: 256px;"><div class="h-48 bg-gray-200 rounded-sm animate-pulse mb-3"></div><div class="h-3 bg-gray-200 rounded w-full animate-pulse"></div></div>').join('');
        document.getElementById('must-read').innerHTML = Array(4).fill(createSkeletonCard()).join('');
        document.getElementById('latest-stories').innerHTML = Array(3).fill('<div class="flex gap-4 animate-pulse"><div class="w-32 h-32 bg-gray-200 rounded-sm"></div><div class="flex-1"><div class="h-3 bg-gray-200 rounded mb-2"></div><div class="h-4 bg-gray-200 rounded mb-2"></div><div class="h-2 bg-gray-200 rounded w-1/2"></div></div></div>').join('');
    }

    // ============================================
    // Load Data from Supabase
    // ============================================
    async function loadData() {
        try {
            const { data: contentItems, error: contentError } = await supabaseClient
                .from('content_items')
                .select('*')
                .order('date', { ascending: false });

            if (contentError) throw contentError;

            state.data.allContent = contentItems || [];
            state.data.heroIds = state.data.allContent.slice(0, 5).map(a => a.id);
            state.data.todayStoriesIds = state.data.allContent.slice(5, 10).map(a => a.id);
            state.data.mustReadIds = state.data.allContent.slice(10, 14).map(a => a.id);

            await initializePage();
        } catch (error) {
            console.error('Error loading data:', error);
            alert('Failed to load data. Please refresh the page.');
        }
    }

    // ============================================
    // Hero Functions
    // ============================================
    function initializeHeroSlides() {
        state.heroSlides = state.data.heroIds
            .map(id => getContentById(id))
            .filter(Boolean);

        if (state.heroSlides.length === 0) return;

        const container = document.getElementById('hero-slides-container');
        container.innerHTML = state.heroSlides.map((hero, index) => {
            const heroImage = hero.image_origin_url || hero.image;
            return `
                <div class="hero-slide ${index === 0 ? 'active' : ''}"
                     style="background-image: ${index === 0 ? `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.5)), url('${heroImage}')` : 'none'}"
                     data-index="${index}"
                     data-image="${heroImage}"
                     data-id="${hero.id}"></div>
            `;
        }).join('');

        const indicators = document.getElementById('hero-indicators');
        indicators.innerHTML = state.heroSlides.map((_, index) => `
            <div class="w-2 h-2 md:w-2.5 md:h-2.5 rounded-full cursor-pointer transition-all ${index === 0 ? 'bg-white' : 'bg-white/50'}" data-index="${index}"></div>
        `).join('');

        document.querySelectorAll('[data-index]').forEach(el => {
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                const index = parseInt(el.dataset.index);
                if (!isNaN(index)) {
                    clearInterval(state.heroInterval);
                    goToSlide(index);
                    startHeroRotation();
                }
            });
        });

        document.getElementById('hero-section').addEventListener('click', () => {
            const hero = state.heroSlides[state.currentHeroIndex];
            window.location.href = `article/index.html?category=${hero.source_type}&id=${hero.id}`;
        });

        setTimeout(() => {
            document.querySelectorAll('.hero-slide').forEach((slide, index) => {
                if (index === 0) return;
                const img = new Image();
                img.onload = () => {
                    slide.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.5)), url('${slide.dataset.image}')`;
                };
                img.src = slide.dataset.image;
            });
        }, 500);
    }

    function goToSlide(index) {
        const slides = document.querySelectorAll('.hero-slide');
        const indicators = document.querySelectorAll('#hero-indicators > div');

        slides[state.currentHeroIndex].classList.remove('active');
        indicators[state.currentHeroIndex].classList.remove('bg-white');
        indicators[state.currentHeroIndex].classList.add('bg-white/50');

        state.currentHeroIndex = index;

        slides[state.currentHeroIndex].classList.add('active');
        indicators[state.currentHeroIndex].classList.add('bg-white');
        indicators[state.currentHeroIndex].classList.remove('bg-white/50');

        renderHero();
    }

    function nextSlide() {
        goToSlide((state.currentHeroIndex + 1) % state.heroSlides.length);
    }

    function startHeroRotation() {
        state.heroInterval = setInterval(nextSlide, 5000);
    }

    // renderHero 함수 수정
    function renderHero(story) {
        const heroSection = document.getElementById('hero-section');
        const category = getCategoryDisplay(story.source);

        heroSection.innerHTML = `
            <div class="hero-card-wrapper">
                <div class="hero-card">
                    <!-- 프로그레시브 이미지 -->
                    <div class="hero-image-container">
                        <img
                            src="${story.image}"
                            alt="${story.title_en}"
                            class="hero-image"
                            loading="eager"
                            decoding="async"
                            onload="this.classList.add('loaded')"
                            onerror="this.src='/assets/placeholder.jpg'"
                        >
                    </div>

                    <div class="hero-overlay">
                        <div class="hero-content">
                            ${story.cultural_badge ? `<div class="cultural-badge">${story.cultural_badge}</div>` : ''}
                            <div class="hero-category">${category}</div>
                            <h1 class="hero-title">${currentLang === 'ko' ? story.title_kor : story.title_en}</h1>
                            <p class="hero-description">${currentLang === 'ko' ? story.desc_kor : story.desc_en}</p>
                            <a href="article/index.html?category=${story.source}&id=${story.id}" class="hero-cta">
                                ${currentLang === 'ko' ? '자세히 보기' : 'Read More'}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }


    // ============================================
    // Render Functions
    // ============================================
    function renderLocationSection() {
        const district = getDistrictMeta(state.currentDistrict);
        if (!district) return;

        document.getElementById('location-title').textContent = state.currentLang === 'kor' ? district.title_kor : district.title_en;
        document.getElementById('location-desc').textContent = state.currentLang === 'kor' ? district.desc_kor : district.desc_en;
    }

    async function renderFashionSection() {
        const district = getDistrictMeta(state.currentDistrict);
        const districtName = district ? (state.currentLang === 'kor' ? district.name_kor : district.name_en) : 'Seongsu';
        document.getElementById('fashion-location-title').textContent = `Fashion for ${districtName}`;

        const districtItems = state.data.allContent.filter(item =>
            item.source_type === 'fashion' && item.district_id === state.currentDistrict
        );
        const generalItems = state.data.allContent.filter(item =>
            item.source_type === 'fashion' && !item.district_id
        );
        const items = [...districtItems, ...generalItems].slice(0, 4);

        document.getElementById('fashion-grid').innerHTML = items.map(item => {
            return `
                <a href="article/index.html?category=${item.source_type}&id=${item.id}" class="block group">
                    <article class="transition-transform hover:-translate-y-1">
                        <div class="relative overflow-hidden mb-3 h-64 bg-gray-100 rounded-sm">
                            ${item.cultural_badge ? `<span class="absolute top-3 left-3 px-2 md:px-3 py-1 text-[9px] md:text-[10px] font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-full">${item.cultural_badge}</span>` : ''}
                            ${createImageWithSkeleton(item.image, item.title_en, 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500')}
                        </div>
                        <div class="text-xs text-gray-500 mb-1 uppercase">${item.category}</div>
                        <h4 class="text-base font-bold leading-tight">${state.currentLang === 'kor' ? item.title_kor : item.title_en}</h4>
                    </article>
                </a>
            `;
        }).join('');
    }

    async function renderBeautySection() {
        const district = getDistrictMeta(state.currentDistrict);
        const districtName = district ? (state.currentLang === 'kor' ? district.name_kor : district.name_en) : 'Seongsu';
        document.getElementById('beauty-location-title').textContent = `Beauty for ${districtName}`;

        const districtItems = state.data.allContent.filter(item =>
            item.source_type === 'beauty' && item.district_id === state.currentDistrict
        );
        const generalItems = state.data.allContent.filter(item =>
            item.source_type === 'beauty' && !item.district_id
        );
        const items = [...districtItems, ...generalItems].slice(0, 4);

        document.getElementById('beauty-grid').innerHTML = items.map(item => {
            return `
                <a href="article/index.html?category=${item.source_type}&id=${item.id}" class="block group">
                    <article class="transition-transform hover:-translate-y-1">
                        <div class="relative overflow-hidden mb-3 h-64 bg-gray-100 rounded-sm">
                            ${item.cultural_badge ? `<span class="absolute top-3 left-3 px-2 md:px-3 py-1 text-[9px] md:text-[10px] font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-full">${item.cultural_badge}</span>` : ''}
                            ${createImageWithSkeleton(item.image, item.title_en, 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500')}
                        </div>
                        <div class="text-xs text-gray-500 mb-1 uppercase">${item.category}</div>
                        <h4 class="text-base font-bold leading-tight">${state.currentLang === 'kor' ? item.title_kor : item.title_en}</h4>
                    </article>
                </a>
            `;
        }).join('');
    }

    async function renderTodayStories() {
        const stories = state.data.todayStoriesIds.map(id => getContentById(id)).filter(Boolean);
        if (stories.length === 0) return;

        const featured = stories[0];
        const small = stories.slice(1);

        const getDistrictName = (districtId) => {
            if (!districtId) return null;
            const district = getDistrictMeta(districtId);
            return district ? (state.currentLang === 'kor' ? district.name_kor : district.name_en) : null;
        };

        document.getElementById('today-stories').innerHTML = `
            <div class="md:col-span-5">
                <a href="article/index.html?category=${featured.source_type}&id=${featured.id}" class="block group">
                    <article class="h-full">
                        <div class="relative overflow-hidden mb-4 h-96 bg-gray-100 rounded-sm">
                            ${featured.district_id ? `<span class="absolute bottom-3 left-3 bg-white/95 px-3 py-1 text-xs font-semibold rounded">${getDistrictName(featured.district_id)}</span>` : ''}
                            ${featured.cultural_badge ? `<span class="absolute top-3 left-3 px-2 md:px-3 py-1 text-[9px] md:text-[10px] font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-full">${featured.cultural_badge}</span>` : ''}
                            ${createImageWithSkeleton(featured.image, featured.title_en, 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500')}
                        </div>
                        <div class="text-xs text-gray-500 mb-2 uppercase tracking-wide">${featured.category}</div>
                        <h3 class="text-2xl font-bold leading-tight">${state.currentLang === 'kor' ? featured.title_kor : featured.title_en}</h3>
                    </article>
                </a>
            </div>
            <div class="md:col-span-7 grid grid-cols-2 gap-4">
                ${small.map(story => `
                    <a href="article/index.html?category=${story.source_type}&id=${story.id}" class="block group">
                        <article>
                            <div class="relative overflow-hidden mb-3 h-48 bg-gray-100 rounded-sm">
                                ${story.district_id ? `<span class="absolute bottom-2 left-2 bg-white/95 px-2 py-1 text-[10px] font-semibold rounded">${getDistrictName(story.district_id)}</span>` : ''}
                                ${story.cultural_badge ? `<span class="absolute top-2 left-2 px-2 py-1 text-[9px] font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-full">${story.cultural_badge}</span>` : ''}
                                ${createImageWithSkeleton(story.image, story.title_en, 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500')}
                            </div>
                            <div class="text-xs text-gray-500 mb-1 uppercase">${story.category}</div>
                            <h4 class="text-sm font-bold leading-tight">${state.currentLang === 'kor' ? story.title_kor : story.title_en}</h4>
                        </article>
                    </a>
                `).join('')}
            </div>
        `;
    }

    async function renderBestStories() {
        const stories = [...state.data.allContent].sort((a, b) => (b.views || 0) - (a.views || 0)).slice(0, 15);

        const getDistrictName = (districtId) => {
            if (!districtId) return null;
            const district = getDistrictMeta(districtId);
            return district ? (state.currentLang === 'kor' ? district.name_kor : district.name_en) : null;
        };

        document.getElementById('best-stories').innerHTML = stories.map(story => `
            <div class="swiper-slide" style="width: 256px;">
                <a href="article/index.html?category=${story.source_type}&id=${story.id}" class="block group">
                    <article>
                        <div class="relative overflow-hidden mb-3 h-48 bg-gray-100 rounded-sm">
                            ${story.district_id ? `<span class="absolute bottom-2 left-2 bg-white/95 px-2 py-1 text-[10px] font-semibold rounded">${getDistrictName(story.district_id)}</span>` : ''}
                            ${story.cultural_badge ? `<span class="absolute top-2 left-2 px-2 py-1 text-[9px] font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-full">${story.cultural_badge}</span>` : ''}
                            ${createImageWithSkeleton(story.image, story.title_en, 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500')}
                        </div>
                        <div class="text-xs text-gray-500 mb-1 uppercase">${story.category}</div>
                        <h4 class="text-base font-bold leading-tight">${state.currentLang === 'kor' ? story.title_kor : story.title_en}</h4>
                    </article>
                </a>
            </div>
        `).join('');

        new Swiper('.best-stories-swiper', {
            slidesPerView: 'auto',
            spaceBetween: 24,
            freeMode: { enabled: true, momentum: true },
            grabCursor: true
        });
    }

    async function renderMustRead() {
        const stories = state.data.mustReadIds.map(id => getContentById(id)).filter(Boolean);

        const getDistrictName = (districtId) => {
            if (!districtId) return null;
            const district = getDistrictMeta(districtId);
            return district ? (state.currentLang === 'kor' ? district.name_kor : district.name_en) : null;
        };

        document.getElementById('must-read').innerHTML = stories.map(item => `
            <a href="article/index.html?category=${item.source_type}&id=${item.id}" class="block group">
                <article>
                    <div class="relative overflow-hidden mb-3 h-56 bg-gray-100 rounded-sm">
                        ${item.district_id ? `<span class="absolute bottom-2 left-2 bg-white/95 px-2 py-1 text-[10px] font-semibold rounded">${getDistrictName(item.district_id)}</span>` : ''}
                        ${item.cultural_badge ? `<span class="absolute top-2 left-2 px-2 py-1 text-[9px] font-semibold bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-full">${item.cultural_badge}</span>` : ''}
                        ${createImageWithSkeleton(item.image, item.title_en, 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500')}
                    </div>
                    <div class="text-xs text-gray-500 mb-1 uppercase">${item.category}</div>
                    <h4 class="text-base font-bold leading-tight mb-2">${state.currentLang === 'kor' ? item.title_kor : item.title_en}</h4>
                    <p class="text-xs text-gray-600">${state.currentLang === 'kor' ? item.desc_kor : item.desc_en}</p>
                </article>
            </a>
        `).join('');
    }

    async function renderLatestStories() {
        const latest = state.data.allContent.slice(0, 3);

        document.getElementById('latest-stories').innerHTML = latest.map(item => `
            <a href="article/index.html?category=${item.source_type}&id=${item.id}" class="flex gap-4 group">
                <div class="w-32 h-32 flex-shrink-0 overflow-hidden bg-gray-100 rounded-sm">
                    ${createImageWithSkeleton(item.image, item.title_en, 'w-full h-full object-cover group-hover:scale-105 transition-transform duration-500')}
                </div>
                <div class="flex-1">
                    <div class="text-xs text-gray-500 mb-1 uppercase">${item.category}</div>
                    <h4 class="text-sm font-bold leading-tight mb-2">${state.currentLang === 'kor' ? item.title_kor : item.title_en}</h4>
                    <p class="text-xs text-gray-600">${formatDate(item.date)}</p>
                </div>
            </a>
        `).join('');
    }

    function renderLocationModal() {
        const currentSelection = state.autoSelectEnabled ? 'auto' : state.currentDistrict;

        document.getElementById('location-options').innerHTML = `
            <button class="w-full text-left p-4 border-2 rounded transition ${currentSelection === 'auto' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 hover:bg-gray-50'}" data-location="auto">
                <div class="font-bold ${currentSelection === 'auto' ? 'text-blue-700' : ''}">🎯 Auto Detect</div>
                <div class="text-sm text-gray-600">Find nearest district automatically</div>
            </button>
            ${state.data.districtMeta.map(district => `
                <button class="w-full text-left p-4 border rounded transition ${currentSelection === district.district_id ? 'border-2 border-blue-500 bg-blue-50' : 'border-gray-300 hover:bg-gray-50'}" data-location="${district.district_id}">
                    <div class="font-bold ${currentSelection === district.district_id ? 'text-blue-700' : ''}">📍 ${state.currentLang === 'kor' ? district.name_kor : district.name_en}</div>
                    <div class="text-sm text-gray-600">${state.currentLang === 'kor' ? district.desc_kor : district.desc_en}</div>
                </button>
            `).join('')}
        `;

        document.querySelectorAll('[data-location]').forEach(btn => {
            btn.addEventListener('click', () => {
                const location = btn.dataset.location;
                if (location === 'auto') {
                    state.autoSelectEnabled = true;
                    saveSession();
                    autoDetectLocation();
                } else {
                    state.autoSelectEnabled = false;
                    state.currentDistrict = location;
                    saveSession();
                    renderLocationSection();
                    renderFashionSection();
                    renderBeautySection();
                }
                document.getElementById('location-modal').classList.add('hidden');
            });
        });
    }

    function autoDetectLocation() {
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition((position) => {
            const { latitude, longitude } = position.coords;

            let closestDistrict = state.data.districtMeta[0];
            let minDistance = Infinity;

            state.data.districtMeta.forEach(district => {
                const distance = calculateDistance(latitude, longitude, district.latitude, district.longitude);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestDistrict = district;
                }
            });

            if (state.currentDistrict !== closestDistrict.district_id) {
                state.currentDistrict = closestDistrict.district_id;
                saveSession();
                renderLocationSection();
                renderFashionSection();
                renderBeautySection();
            }
        });
    }

    // ============================================
    // Event Handlers
    // ============================================
    function setupEventListeners() {
        document.getElementById('lang-toggle').addEventListener('click', () => {
            state.currentLang = state.currentLang === 'kor' ? 'en' : 'kor';
            document.getElementById('lang-text').textContent = state.currentLang === 'kor' ? '한국어' : 'English';
            saveSession();

            renderHero();
            renderLocationSection();
            renderFashionSection();
            renderBeautySection();
            renderTodayStories();
            renderBestStories();
            renderMustRead();
            renderLatestStories();
            renderLocationModal();
        });

        document.getElementById('change-location').addEventListener('click', () => {
            renderLocationModal();
            document.getElementById('location-modal').classList.remove('hidden');
        });

        document.getElementById('close-location-modal').addEventListener('click', () => {
            document.getElementById('location-modal').classList.add('hidden');
        });

        document.getElementById('location-modal').addEventListener('click', (e) => {
            if (e.target.id === 'location-modal') {
                document.getElementById('location-modal').classList.add('hidden');
            }
        });

        document.getElementById('newsletter-submit').addEventListener('click', () => {
            const email = document.getElementById('newsletter-email').value;
            if (email && email.includes('@')) {
                alert(state.currentLang === 'kor' ? '구독해 주셔서 감사합니다!' : 'Thank you for subscribing!');
                document.getElementById('newsletter-email').value = '';
            } else {
                alert(state.currentLang === 'kor' ? '유효한 이메일 주소를 입력해주세요.' : 'Please enter a valid email address.');
            }
        });

        document.querySelector('a[href="#newsletter-section"]').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('newsletter-section').scrollIntoView({ behavior: 'smooth' });
        });
    }

    // ============================================
    // Initialize Page (Sequential Loading)
    // ============================================
    async function initializePage() {
        // 1. Load session & text content
        loadSession();
        renderLocationSection();

        // 2. Show skeletons
        showSkeletons();

        // 3. Load Hero
        initializeHeroSlides();
        startHeroRotation();
        renderHero();
        await delay(150);

        // 4. Load Fashion images
        await renderFashionSection();
        await delay(150);

        // 5. Load Beauty images
        await renderBeautySection();
        await delay(150);

        // 6. Load Today's Stories images
        await renderTodayStories();
        await delay(150);

        // 7. Load Best Stories images
        await renderBestStories();
        await delay(150);

        // 8. Load Must Read images
        await renderMustRead();
        await delay(150);

        // 9. Load Latest Stories images
        await renderLatestStories();

        // 10. Setup rest
        renderLocationModal();
        setupEventListeners();

        if (state.autoSelectEnabled) {
            setTimeout(autoDetectLocation, 100);
        }
    }

    // Start
    loadData();
</script>
</body>
</html>